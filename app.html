<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3DREAM LABS - AI-Powered 3D Modeling</title>
<!-- Favicon -->
<link rel="icon" type="image/png" href="/favicon.png">
<script src="https://cdn.tailwindcss.com" defer></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/STLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/exporters/STLExporter.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/exporters/OBJExporter.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/exporters/GLTFExporter.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-storage-compat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: {
        'sans': ['Inter', 'sans-serif'],
      },
      colors: {
        primary: '#f97316', // Orange primary color
        accent: '#ea580c',  // Darker orange accent color
        light: '#1a1a1a',   // Dark background
        gray: {
          50: '#f9fafb',
          100: '#f3f4f6',
          200: '#e5e7eb',
          300: '#d1d5db',
          400: '#9ca3af',
          500: '#6b7280',
          600: '#4b5563',
          700: '#374151',
          800: '#1f2937',
          900: '#111827',
        }
      },
    }
  }
}
</script>
<style>
/* Base styles */
body {
  font-family: 'Inter', sans-serif;
  background-color: #1a1a1a;
  color: #ffffff;
  overflow-x: hidden;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  background: #374151;
}
::-webkit-scrollbar-thumb {
  background: #f97316;
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: #ea580c;
}

/* Animations */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
.loading-pulse {
  animation: pulse 1.5s ease-in-out infinite;
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}
        
@keyframes float {
  0% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-15px);
  }
  100% {
    transform: translateY(0px);
  }
}

/* Eclipse Loading Animation */
.eclipse-loading-container {
  background: #000000;
  border-radius: 8px;
  padding: 60px;
  position: relative;
  overflow: hidden;
  min-height: 400px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 1px solid #333;
}

.eclipse-animation {
  position: relative;
  width: 200px;
  height: 200px;
  margin-bottom: 40px;
}

.eclipse-circle {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: #000000;
  border: 3px solid transparent;
  background-clip: padding-box;
}

.eclipse-glow {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: conic-gradient(
    from 0deg,
    transparent 0deg,
    #00ffff 60deg,
    #ffff00 120deg,
    transparent 180deg,
    transparent 360deg
  );
  animation: eclipse-rotate 3s linear infinite;
  filter: blur(8px);
  opacity: 0.9;
}

.eclipse-rim {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: conic-gradient(
    from 0deg,
    transparent 0deg,
    #00bfff 60deg,
    #ffd700 120deg,
    transparent 180deg,
    transparent 360deg
  );
  animation: eclipse-rotate 3s linear infinite;
  opacity: 0.8;
}

.eclipse-inner-shadow {
  position: absolute;
  top: 3px;
  left: 3px;
  right: 3px;
  bottom: 3px;
  border-radius: 50%;
  background: #000000;
  box-shadow: inset 0 0 20px rgba(0, 191, 255, 0.3);
}

@keyframes eclipse-rotate {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

/* Loading Text Animation */
.loading-text {
  font-size: 1.5rem;
  font-weight: 600;
  background: linear-gradient(
    45deg,
    #00bfff 0%,
    #ffd700 25%,
    #00bfff 50%,
    #ffd700 75%,
    #00bfff 100%
  );
  background-size: 200% 200%;
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: gradient-flow 2s ease-in-out infinite;
  text-align: center;
  letter-spacing: 2px;
}

@keyframes gradient-flow {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

/* 3D Processing Animation (old) */
.processing-container {
  background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
  border-radius: 8px;
  padding: 40px;
  position: relative;
  overflow: hidden;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 1px solid #4b5563;
}

.processing-animation {
  position: relative;
  width: 120px;
  height: 120px;
  margin-bottom: 30px;
}

.orbit-container {
  position: absolute;
  width: 100%;
  height: 100%;
  animation: rotate 8s linear infinite;
}

.orbit-element {
  position: absolute;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: linear-gradient(45deg, #f97316, #ea580c);
  box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
}

.orbit-element:nth-child(1) {
  top: 0;
  left: 50%;
  margin-left: -6px;
  animation: pulse-element 2s ease-in-out infinite;
}

.orbit-element:nth-child(2) {
  top: 25%;
  right: 0;
  margin-top: -6px;
  animation: pulse-element 2s ease-in-out infinite 0.5s;
}

.orbit-element:nth-child(3) {
  bottom: 0;
  left: 50%;
  margin-left: -6px;
  animation: pulse-element 2s ease-in-out infinite 1s;
}

.orbit-element:nth-child(4) {
  top: 25%;
  left: 0;
  margin-top: -6px;
  animation: pulse-element 2s ease-in-out infinite 1.5s;
}

.center-element {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 24px;
  height: 24px;
  margin-top: -12px;
  margin-left: -12px;
  background: linear-gradient(45deg, #ea580c, #dc2626);
  border-radius: 6px;
  animation: center-pulse 3s ease-in-out infinite;
  box-shadow: 0 4px 12px rgba(234, 88, 12, 0.4);
}

@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@keyframes pulse-element {
  0%, 100% {
    transform: scale(1);
    opacity: 0.7;
  }
  50% {
    transform: scale(1.4);
    opacity: 1;
  }
}

@keyframes center-pulse {
  0%, 100% {
    transform: scale(1) rotate(0deg);
    opacity: 0.8;
  }
  50% {
    transform: scale(1.2) rotate(180deg);
    opacity: 1;
  }
}

.processing-counter {
  color: #d1d5db;
  font-family: 'Inter', 'Courier New', monospace;
  font-size: 13px;
  font-weight: 500;
  text-align: right;
  position: absolute;
  bottom: 16px;
  right: 16px;
  background: rgba(31, 41, 55, 0.9);
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid #4b5563;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(8px);
}

/* 3D viewer custom styles */
#preview-container {
  position: relative;
  overflow: hidden;
  border-radius: 0.5rem;
  background: #000000;
}

/* 3D Preview Styles */
.preview-controls {
  position: absolute;
  top: 1rem;
  right: 1rem;
  display: flex;
  gap: 0.5rem;
  z-index: 10;
}

.preview-controls button {
  background-color: #4b5563;
  color: #ffffff;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.preview-controls button:hover {
  background-color: #6b7280;
}

.preview-controls button.active {
  background-color: #f97316;
}

.preview-info {
  position: absolute;
  bottom: 1rem;
  left: 1rem;
  right: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 10;
}

.preview-instructions {
  background: rgba(0, 0, 0, 0.7);
  color: #ffffff;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
}

.preview-stats {
  background: rgba(0, 0, 0, 0.7);
  color: #ffffff;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
}

/* File input styling */
.file-input-wrapper {
  position: relative;
  display: inline-block;
  cursor: pointer;
}
.file-input-wrapper input[type="file"] {
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

/* Image preview container */
.image-preview-container {
  position: relative;
  display: inline-block;
}

/* Delete button for uploaded image */
.delete-image-btn {
  position: absolute;
  top: -10px;
  right: -10px;
  background-color: #f97316;
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 12px;
  z-index: 10;
  border: 2px solid #1a1a1a;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Modal styles */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  z-index: 50;
  align-items: center;
  justify-content: center;
}
.modal-content {
  background-color: #1f2937;
  border-radius: 0.5rem;
  max-width: 90%;
  width: 400px;
  max-height: 90vh;
  overflow-y: auto;
  border: 1px solid #4b5563;
}

/* Password strength indicator */
.password-strength {
  height: 5px;
  margin-top: 5px;
  border-radius: 2px;
  transition: all 0.3s ease;
}

.strength-weak {
  background-color: #ef4444;
  width: 30%;
}

.strength-medium {
  background-color: #f59e0b;
  width: 60%;
}

.strength-strong {
  background-color: #10b981;
  width: 100%;
}

/* Completely customized select dropdown to fix cross-browser issues */
.custom-select-wrapper {
  position: relative;
  user-select: none;
  width: 100%;
}

.custom-select {
  position: relative;
  display: flex;
  flex-direction: column;
}

.custom-select__trigger {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0.75rem;
  font-size: 1rem;
  font-weight: 500;
  color: white;
  background-color: #f97316;
  cursor: pointer;
  border-radius: 0.375rem;
  border: 1px solid #f97316;
}

.custom-select__trigger:hover {
  background-color: #ea580c;
}

.custom-select__icon {
  position: relative;
  width: 16px;
  height: 16px;
  transition: transform 0.3s ease;
}

.custom-select__icon path {
  stroke: white;
}

.custom-options {
  position: absolute;
  display: block;
  top: 100%;
  left: 0;
  right: 0;
  border: 1px solid #f97316;
  border-top: 0;
  background-color: #1f2937;
  font-weight: 500;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  z-index: 20;
  border-bottom-left-radius: 0.375rem;
  border-bottom-right-radius: 0.375rem;
  margin-top: 0px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  transform: translateY(-10px);
  transition: all 0.2s ease-in-out;
}

.custom-select.open .custom-options {
  opacity: 1;
  visibility: visible;
  pointer-events: all;
  transform: translateY(0);
}

.custom-select.open .custom-select__icon {
  transform: rotate(180deg);
}

.custom-option {
  position: relative;
  display: block;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.custom-option:hover {
  background-color: #374151;
}

.custom-option.selected {
  background-color: #374151;
  font-weight: 600;
}

/* Orange shadow for interactive elements */
.orange-shadow {
  box-shadow: 0 0 15px rgba(249, 115, 22, 0.1);
}

/* Google sign-in button styles */
.google-signin-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #1f2937;
  color: #d1d5db;
  border-radius: 4px;
  padding: 10px 16px;
  font-family: 'Roboto', Arial, sans-serif;
  font-size: 16px;
  font-weight: 500;
  width: 100%;
  border: 1px solid #4b5563;
  cursor: pointer;
  transition: background-color 0.3s;
}

.google-signin-btn:hover {
  background-color: #374151;
}

.google-signin-btn img {
  width: 18px;
  height: 18px;
  margin-right: 10px;
}

/* Loading spinner */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.1);
  border-radius: 50%;
  border-top-color: #f97316;
  animation: spin 1s ease-in-out infinite;
  margin-right: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* User profile dropdown menu */
.profile-dropdown {
  position: relative;
}

.profile-dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  transform-origin: top right;
  transform: scale(0.95);
  width: 270px;
  margin-top: 0.5rem;
  background-color: #1f2937;
  border-radius: 0.5rem;
  padding: 0.75rem 0;
  box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
  z-index: 50;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease, transform 0.15s ease;
  border: 1px solid #4b5563;
}

.profile-dropdown-menu.active {
  opacity: 1;
  transform: scale(1);
  pointer-events: auto;
}

.profile-dropdown-item {
  display: flex;
  align-items: center;
  padding: 0.75rem 1.25rem;
  color: #ffffff;
  font-weight: 500;
  transition: background-color 0.15s ease;
}

.profile-dropdown-item:hover {
  background-color: #374151;
}

.profile-dropdown-item svg {
  margin-right: 0.75rem;
}

.profile-dropdown-divider {
  height: 1px;
  margin: 0.5rem 0;
  background-color: #4b5563;
}

.profile-dropdown-header {
  padding: 0.75rem 1.25rem;
  border-bottom: 1px solid #4b5563;
  margin-bottom: 0.5rem;
}

.profile-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  cursor: pointer;
  overflow: hidden;
  border: 2px solid #f97316;
  transition: border-color 0.2s ease;
}

.profile-avatar:hover {
  border-color: #ea580c;
}

.profile-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-initials {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f97316;
  color: white;
  font-weight: bold;
  font-size: 16px;
}

/* AI generation logs */
#ai-logs {
  background-color: #1f2937;
  border: 1px solid #4b5563;
  border-radius: 0.5rem;
  padding: 0.75rem;
  height: 150px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 0.875rem;
  margin-top: 1rem;
  transition: height 0.3s ease;
}

#ai-logs.expanded {
  height: 300px;
}

.log-line {
  margin-bottom: 0.5rem;
  line-height: 1.4;
  word-break: break-word;
}

.log-time {
  color: #f59e0b;
  margin-right: 0.5rem;
}

.log-info {
  color: #10b981;
}

.log-warn {
  color: #f59e0b;
}

.log-error {
  color: #ef4444;
}

.log-success {
  color: #10b981;
}

.logo-container {
  width: 60px;
  height: 60px;
  overflow: hidden;
  border-radius: 50%;
  margin-right: 12px;
}

.logo-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.button-orange {
  background-color: #f97316;
  color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.button-orange:hover {
  background-color: #ea580c;
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(249, 115, 22, 0.2);
}

.feature-card {
  background-color: #1f2937;
  transition: all 0.3s ease;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  border: 1px solid #4b5563;
}

.feature-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(249, 115, 22, 0.2);
  border-color: #f97316;
}

.hero-gradient {
  background: linear-gradient(135deg, #1f1f1f 0%, #0f0f0f 50%, #1f1f1f 100%);
}

.gradient-text {
  background: linear-gradient(90deg, #f97316, #ea580c);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Rating stars */
.star-rating {
  display: flex;
  justify-content: center;
  margin: 15px 0;
}

.star {
  font-size: 2rem;
  color: #4b5563;
  cursor: pointer;
  transition: color 0.2s ease;
}

.star:hover, .star.active {
  color: #f59e0b;
}

#model-viewer {
  display: none;
  visibility: hidden;
  opacity: 0;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1000;
  background: #1a1a1a;
  transition: opacity 0.3s ease;
}

#model-viewer.active {
  display: block;
  visibility: visible;
  opacity: 1;
}

.loading {
  position: relative;
  pointer-events: none;
}

.loading::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  top: 50%;
  left: 50%;
  margin: -10px 0 0 -10px;
  border: 2px solid #fff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: button-loading-spinner 1s linear infinite;
}

@keyframes button-loading-spinner {
  from {
    transform: rotate(0turn);
  }
  to {
    transform: rotate(1turn);
  }
}

/* Slide overlay styles */
.page-transition-overlay {
  position: fixed;
  left: 0; top: 0; right: 0; bottom: 0;
  background: #1a1a1a;
  z-index: 9999;
  pointer-events: none;
  transform: translateX(-100%);
  transition: transform 0.35s cubic-bezier(.77,0,.18,1);
}
.page-transition-overlay.active {
  transform: translateX(0);
  pointer-events: all;
}

/* Header scroll behavior */
.header-hidden {
  transform: translateY(-100%);
}

.header-visible {
  transform: translateY(0);
}

/* Fullscreen styles */
.fullscreen-viewer {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 9999 !important;
  background: #000000 !important;
}

.fullscreen-viewer .preview-controls {
  top: 2rem;
  right: 2rem;
}

.fullscreen-viewer .preview-info {
  bottom: 2rem;
  left: 2rem;
  right: 2rem;
}
</style>

<!-- How It Works diagram styles (updated) -->
<style>
    .diagram-container {
        width: 1200px;
        height: 800px;
        background: #1f2937;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        padding: 40px;
        position: relative;
        overflow: hidden;
        box-sizing: border-box;
        border: 1px solid #4b5563;
    }
    .title {
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 40px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .flow-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 20px;
        height: 640px;
        position: relative;
    }
    .step-box {
        background: #374151;
        border: 2px solid #4b5563;
        border-radius: 16px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .step-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(249, 115, 22, 0.15);
        border-color: #f97316;
    }
    .step-number {
        position: absolute;
        top: -12px;
        left: 20px;
        background: #f97316;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .step-icon {
        font-size: 32px;
        margin-bottom: 15px;
    }
    .step-title {
        font-size: 16px;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 10px;
        line-height: 1.2;
    }
    .step-description {
        font-size: 13px;
        color: #d1d5db;
        line-height: 1.4;
    }
    /* Grid positioning */
    .step-1 {
        grid-column: 1;
        grid-row: 1;
        background: #1f2937;
        border-color: #6b7280;
    }
    .step-2 {
        grid-column: 2;
        grid-row: 1;
        background: #f97316;
        color: white;
        border-color: #ea580c;
    }
    .step-3 {
        grid-column: 3;
        grid-row: 1;
        background: #374151;
        border-color: #9ca3af;
    }
    .step-4 {
        grid-column: 3;
        grid-row: 2;
        background: #1f2937;
        border-color: #6b7280;
    }
    .step-5 {
        grid-column: 3;
        grid-row: 3;
        background: #374151;
        border-color: #9ca3af;
    }
    .step-6 {
        grid-column: 2;
        grid-row: 3;
        background: #1f2937;
        border-color: #6b7280;
    }
    .step-7 {
        grid-column: 1;
        grid-row: 3;
        background: #f97316;
        color: white;
        border-color: #ea580c;
    }
    .step-8 {
        grid-column: 1;
        grid-row: 2;
        background: #ea580c;
        color: white;
        border-color: #dc2626;
    }
    .step-2 .step-title,
    .step-2 .step-description,
    .step-7 .step-title,
    .step-7 .step-description,
    .step-8 .step-title,
    .step-8 .step-description {
        color: white;
    }
    .fallback-note {
        background: #1f2937;
        border: 1px solid #9ca3af;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 10px;
        color: #6b7280;
        margin-top: 8px;
    }
    /* Flow indicator - subtle glow effect on boxes */
    .step-box::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: rgba(249, 115, 22, 0.1);
        border-radius: 18px;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .step-box:hover::after {
        opacity: 1;
    }
    
    /* 3DREAM LABZ Text Styles */
    .dream-text {
        font-size: 2.2rem;
        font-weight: bold;
        color: #f0f0f0;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        letter-spacing: 3px;
        background: linear-gradient(45deg, #ffffff, #cccccc, #ffffff);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: none;
        transform-style: preserve-3d;
        perspective: 1000px;
        display: inline-block;
        white-space: nowrap;
    }

    .dream-text::before {
        content: '3DREAM LABZ';
        position: absolute;
        top: 0;
        left: 0;
        color: #666;
        transform: translateZ(-20px) translateX(2px) translateY(2px);
        -webkit-text-fill-color: #666;
        background: none;
        z-index: -1;
    }

    .dream-text::after {
        content: '3DREAM LABZ';
        position: absolute;
        top: 0;
        left: 0;
        color: #888;
        transform: translateZ(-10px) translateX(1px) translateY(1px);
        -webkit-text-fill-color: #888;
        background: none;
        z-index: -1;
    }

    .dream-text:hover {
        background: linear-gradient(45deg, #f97316, #ea580c, #f97316);
        background-clip: text;
        -webkit-background-clip: text;
        transform: scale(1.1) rotateX(15deg) rotateY(-10deg);
        filter: drop-shadow(0 0 20px rgba(249, 115, 22, 0.8));
    }

    .dream-text:hover::before {
        transform: translateZ(-30px) translateX(3px) translateY(3px);
        color: #444;
        -webkit-text-fill-color: #444;
    }

    .dream-text:hover::after {
        transform: translateZ(-20px) translateX(2px) translateY(2px);
        color: #666;
        -webkit-text-fill-color: #666;
    }

    .particles {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .particle {
        position: absolute;
        width: 2px;
        height: 2px;
        background: #f97316;
        border-radius: 50%;
        opacity: 0;
        animation: float 3s infinite ease-in-out;
    }

    @keyframes float {
        0%, 100% {
            opacity: 0;
            transform: translateY(0px);
        }
        50% {
            opacity: 1;
            transform: translateY(-20px);
        }
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.05);
            opacity: 0.8;
        }
    }
    
    /* Center container for 3DREAM LABZ text */
    .dream-center {
        grid-column: 2;
        grid-row: 2;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        z-index: 10;
        white-space: nowrap;
    }
</style>
</head>
<body class="bg-gray-900 text-white">
<div class="page-transition-overlay" id="pageTransitionOverlay"></div>
<div class="min-h-screen flex flex-col">
<!-- Auth modals -->
<div id="login-modal" class="modal">
<div class="modal-content p-6">
<h2 class="text-xl font-semibold mb-4 text-white">Login to 3DREAM LABS</h2>

<!-- Google Sign-In Button -->
<div class="mb-4">
  <button id="google-signin-btn" class="google-signin-btn border border-gray-600">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 48 48">
      <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
      <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
      <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
      <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
    </svg>
    <span id="google-signin-text">Sign in with Google</span>
    <span id="google-signin-loading" class="loading-spinner hidden"></span>
  </button>
</div>

<div class="flex items-center my-4">
  <hr class="flex-1 border-gray-600">
  <div class="px-3 text-sm text-gray-400">OR</div>
  <hr class="flex-1 border-gray-600">
</div>

<form id="login-form" class="space-y-4">
<div>
<label for="login-email" class="block text-sm font-medium mb-1 text-gray-300">Email</label>
<input type="email" id="login-email" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
</div>
<div>
<label for="login-password" class="block text-sm font-medium mb-1 text-gray-300">Password</label>
<input type="password" id="login-password" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
</div>
<div class="text-right">
  <button type="button" id="forgot-password-btn" class="text-sm text-orange-400 hover:text-orange-300 transition-colors">Forgot password?</button>
</div>
<div id="login-error" class="text-red-500 text-sm hidden"></div>
<div class="flex justify-between">
<button type="submit" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Login</button>
<button type="button" id="go-to-signup" class="px-4 py-2 text-orange-400 hover:text-orange-300 transition-colors">Sign Up</button>
</div>
</form>
</div>
</div>

<div id="signup-modal" class="modal">
<div class="modal-content p-6">
<h2 class="text-xl font-semibold mb-4 text-white">Create an Account</h2>

<!-- Google Sign-In Button for signup -->
<div class="mb-4">
  <button id="google-signup-btn" class="google-signin-btn border border-gray-600">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 48 48">
      <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
      <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
      <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
      <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
    </svg>
    <span id="google-signup-text">Sign up with Google</span>
    <span id="google-signup-loading" class="loading-spinner hidden"></span>
  </button>
</div>

<div class="flex items-center my-4">
  <hr class="flex-1 border-gray-600">
  <div class="px-3 text-sm text-gray-400">OR</div>
  <hr class="flex-1 border-gray-600">
</div>

<form id="signup-form" class="space-y-4">
<!-- Profile Picture Upload -->
<div class="flex justify-center mb-2">
  <div class="relative inline-block">
    <div id="profile-pic-preview" class="w-24 h-24 rounded-full bg-gray-700 flex items-center justify-center cursor-pointer overflow-hidden border-2 border-orange-500">
      <!-- Default avatar shown until an image is uploaded -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
      <img id="profile-pic-img" class="absolute inset-0 w-full h-full object-cover hidden" src="" alt="Profile picture">
    </div>
    <div class="absolute bottom-0 right-0 bg-orange-500 rounded-full p-1 cursor-pointer">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </div>
    <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
    <p class="text-xs text-center text-gray-400 mt-1">Optional Profile Picture</p>
  </div>
</div>

<!-- Full Name Field -->
<div>
  <label for="signup-fullname" class="block text-sm font-medium mb-1 text-gray-300">Full Name</label>
  <input type="text" id="signup-fullname" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
</div>

<!-- Email Field -->
<div>
<label for="signup-email" class="block text-sm font-medium mb-1 text-gray-300">Email</label>
<input type="email" id="signup-email" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
</div>

<!-- Password Field -->
<div>
<label for="signup-password" class="block text-sm font-medium mb-1 text-gray-300">Password</label>
<input type="password" id="signup-password" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required minlength="6">
<div id="password-strength" class="password-strength"></div>
<p class="text-xs text-gray-400 mt-1">Password must be at least 6 characters with numbers and special characters</p>
</div>

<!-- Confirm Password Field -->
<div>
<label for="signup-confirm-password" class="block text-sm font-medium mb-1 text-gray-300">Confirm Password</label>
<input type="password" id="signup-confirm-password" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
</div>
<div id="signup-error" class="text-red-500 text-sm hidden"></div>
<div class="flex justify-between">
<button type="submit" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Sign Up</button>
<button type="button" id="go-to-login" class="px-4 py-2 text-orange-400 hover:text-orange-300 transition-colors">Login Instead</button>
</div>
</form>
</div>
</div>

<!-- Reset Password Modal -->
<div id="reset-password-modal" class="modal">
<div class="modal-content p-6">
<h2 class="text-xl font-semibold mb-4 text-white">Reset Password</h2>
<p class="text-gray-300 mb-4">Enter your email address below and we'll send you a link to reset your password.</p>
<form id="reset-password-form" class="space-y-4">
<div>
<label for="reset-email" class="block text-sm font-medium mb-1 text-gray-300">Email</label>
<input type="email" id="reset-email" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
</div>
<div id="reset-password-error" class="text-red-500 text-sm hidden"></div>
<div id="reset-password-success" class="text-green-500 text-sm hidden"></div>
<div class="flex justify-between">
<button type="submit" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Send Reset Link</button>
<button type="button" id="cancel-reset-password" class="px-4 py-2 text-orange-400 hover:text-orange-300 transition-colors">Cancel</button>
</div>
</form>
</div>
</div>

<!-- Edit Account Modal -->
<div id="edit-account-modal" class="modal">
<div class="modal-content p-6">
<h2 class="text-xl font-semibold mb-4 text-white">Edit Account Details</h2>
<form id="edit-account-form" class="space-y-4">
<!-- Profile Picture Upload -->
<div class="flex justify-center mb-2">
  <div class="relative inline-block">
    <div id="edit-profile-pic-preview" class="w-24 h-24 rounded-full bg-gray-700 flex items-center justify-center cursor-pointer overflow-hidden border-2 border-orange-500">
      <!-- Default avatar shown until an image is uploaded -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
      <img id="edit-profile-pic-img" class="absolute inset-0 w-full h-full object-cover hidden" src="" alt="Profile picture">
    </div>
    <div class="absolute bottom-0 right-0 bg-orange-500 rounded-full p-1 cursor-pointer">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </div>
    <input type="file" id="edit-profile-pic-upload" class="hidden" accept="image/*">
  </div>
</div>

<!-- Full Name Field -->
<div>
  <label for="edit-fullname" class="block text-sm font-medium mb-1 text-gray-300">Full Name</label>
  <input type="text" id="edit-fullname" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
</div>

<div id="edit-account-error" class="text-red-500 text-sm hidden"></div>
<div id="edit-account-success" class="text-green-500 text-sm hidden"></div>
<div class="flex justify-between">
<button type="submit" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Save Changes</button>
<button type="button" id="cancel-edit-account" class="px-4 py-2 text-orange-400 hover:text-orange-300 transition-colors">Cancel</button>
</div>
</form>
</div>
</div>

<!-- Change Password Modal -->
<div id="change-password-modal" class="modal">
<div class="modal-content p-6">
<h2 class="text-xl font-semibold mb-4 text-white">Change Password</h2>
<form id="change-password-form" class="space-y-4">
<div>
<label for="current-password" class="block text-sm font-medium mb-1 text-gray-300">Current Password</label>
<input type="password" id="current-password" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
</div>
<div>
<label for="new-password" class="block text-sm font-medium mb-1 text-gray-300">New Password</label>
<input type="password" id="new-password" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required minlength="6">
<div id="new-password-strength" class="password-strength"></div>
</div>
<div>
<label for="confirm-new-password" class="block text-sm font-medium mb-1 text-gray-300">Confirm New Password</label>
<input type="password" id="confirm-new-password" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
</div>
<div id="change-password-error" class="text-red-500 text-sm hidden"></div>
<div id="change-password-success" class="text-green-500 text-sm hidden"></div>
<div class="flex justify-between">
<button type="submit" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Change Password</button>
<button type="button" id="cancel-change-password" class="px-4 py-2 text-orange-400 hover:text-orange-300 transition-colors">Cancel</button>
</div>
</form>
</div>
</div>

<!-- Out of tokens modal -->
<div id="out-of-tokens-modal" class="modal">
<div class="modal-content p-6">
<h2 class="text-xl font-semibold mb-4 text-white">Out of Tokens</h2>
<p class="mb-4 text-gray-300">You have run out of tokens. Purchase more tokens to continue generating 3D models.</p>
<div class="flex flex-col space-y-3">
<button id="buy-more-tokens-btn" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Buy More Tokens</button>
<button id="out-of-tokens-close" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors">Close</button>
</div>
</div>
</div>

<!-- Custom alert modal -->
<div id="alert-modal" class="modal">
<div class="modal-content p-6">
<h2 id="alert-title" class="text-xl font-semibold mb-4 text-white">Alert</h2>
<p id="alert-message" class="mb-4 text-gray-300"></p>
<div class="flex justify-end">
<button id="alert-close" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">OK</button>
</div>
</div>
</div>

<!-- Rating modal -->
<div id="rating-modal" class="modal">
<div class="modal-content p-6">
<h2 class="text-xl font-semibold mb-4 text-white">Rate Your Experience</h2>
<p class="text-gray-300 mb-4">How would you rate your experience with 3DREAM LABS?</p>
<div class="star-rating">
  <div class="star" data-value="1">★</div>
  <div class="star" data-value="2">★</div>
  <div class="star" data-value="3">★</div>
  <div class="star" data-value="4">★</div>
  <div class="star" data-value="5">★</div>
</div>
<div class="mt-4">
  <label for="rating-feedback" class="block text-sm font-medium mb-1 text-gray-300">Feedback (optional)</label>
  <textarea id="rating-feedback" rows="3" class="text-base w-full px-3 py-2 bg-gray-800 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Tell us what you think..."></textarea>
</div>
<div class="flex justify-between mt-6">
<button id="rating-submit" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Submit Rating</button>
<button id="rating-close" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors">Maybe Later</button>
</div>
</div>
</div>

<!-- Header -->
<header class="fixed w-full bg-black/90 backdrop-blur-md z-50 shadow-lg border-b border-orange-500/30 transition-transform duration-300 header-visible" id="mainHeader">
<div class="container mx-auto px-4 py-3 flex justify-between items-center">
<div class="flex items-center space-x-1">
  <div class="logo-container">
    <img src="favicon.png" alt="3DREAM LABS" style="width: 80%; height: 80%; object-fit: contain; margin: 10%;" class="object-cover">
  </div>
  <div class="text-white font-bold text-2xl" style="font-family: 'Poppins', 'Inter', sans-serif; letter-spacing: 1px;">
  3DREAM <span style="color: #f97316; background: rgba(249, 115, 22, 0.1); padding: 2px 10px; border-radius: 3px;">LABZ</span>
</div>
</div>

<div class="flex items-center">
<!-- Navigation -->
<nav class="hidden md:flex items-center space-x-4 mr-8">
<button id="app-btn" class="px-3 py-1 rounded-md text-white bg-orange-500 hover:bg-orange-600 transition-colors">App</button>
<button id="dashboard-btn" class="px-3 py-1 rounded-md text-gray-300 hover:bg-gray-700 transition-colors">Dashboard</button>
<button id="howitworks-btn" class="px-3 py-1 rounded-md text-gray-300 hover:bg-gray-700 transition-colors">How It Works</button>
<button id="pricing-btn" class="px-3 py-1 rounded-md text-gray-300 hover:bg-gray-700 transition-colors">Pricing</button>
<button id="help-btn" class="px-3 py-1 rounded-md text-gray-300 hover:bg-gray-700 transition-colors">Help</button>
</nav>

<!-- User info/login area -->
<div id="user-area" class="flex items-center space-x-4">
<div id="logged-out-state" class="flex space-x-2">
<button id="login-btn" class="px-3 py-1 rounded-md text-gray-300 border border-gray-600 hover:bg-gray-700 transition-colors">Login</button>
<button id="signup-btn" class="px-3 py-1 rounded-md text-white bg-orange-500 hover:bg-orange-600 transition-colors">Sign Up</button>
</div>
<div id="logged-in-state" class="hidden flex items-center space-x-2">
<div class="profile-dropdown">
  <div id="profile-avatar" class="profile-avatar">
    <!-- Profile image or initials will be inserted here via JavaScript -->
  </div>
  <!-- User profile dropdown menu -->
  <div id="profile-dropdown-menu" class="profile-dropdown-menu">
    <div class="profile-dropdown-header">
      <div class="text-sm font-medium text-white truncate" id="dropdown-user-name">User Name</div>
      <div class="text-xs text-gray-400 truncate" id="dropdown-user-email">user@example.com</div>
    </div>
    <a href="#" class="profile-dropdown-item" id="edit-account-btn">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
      Edit Profile
    </a>
    <a href="#" class="profile-dropdown-item" id="change-password-btn">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
      </svg>
      Change Password
    </a>
    <a href="#" class="profile-dropdown-item" id="view-dashboard-btn">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg>
      My Dashboard
    </a>
    <a href="#" class="profile-dropdown-item" id="view-subscription-btn">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
      </svg>
      My Subscription
    </a>
    <div class="profile-dropdown-divider"></div>
    <a href="#" class="profile-dropdown-item" id="help-support-btn">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Help & Support
    </a>
    <div class="profile-dropdown-divider"></div>
    <a href="#" class="profile-dropdown-item" id="dropdown-logout-btn">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg>
      Sign Out
    </a>
  </div>
</div>
</div>
</div>

<div class="md:hidden flex items-center">
<button id="mobile-menu-btn" class="text-white p-2">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
</svg>
</button>
</div>
</div>
<!-- Mobile menu -->
<div id="mobile-menu" class="hidden md:hidden bg-gray-900 border-b border-gray-700">
<div class="px-4 py-2 space-y-2">
<button id="mobile-app-btn" class="block w-full text-left px-3 py-2 rounded-md text-white bg-orange-500 hover:bg-orange-600 transition-colors">App</button>
<button id="mobile-dashboard-btn" class="block w-full text-left px-3 py-2 rounded-md text-gray-300 hover:bg-gray-700 transition-colors">Dashboard</button>
<button id="mobile-howitworks-btn" class="block w-full text-left px-3 py-2 rounded-md text-gray-300 hover:bg-gray-700 transition-colors">How It Works</button>
<button id="mobile-pricing-btn" class="block w-full text-left px-3 py-2 rounded-md text-gray-300 hover:bg-gray-700 transition-colors">Pricing</button>
<button id="mobile-help-btn" class="block w-full text-left px-3 py-2 rounded-md text-gray-300 hover:bg-gray-700 transition-colors">Help</button>
</div>
</div>
</header>

<!-- Main content area -->
<main class="flex-grow container mx-auto px-4 py-6 pt-20">
<!-- Login Required Banner -->
<div id="login-required-banner" class="mb-6 bg-gray-800 p-4 rounded-lg border border-gray-600 shadow-sm">
<div class="flex flex-col sm:flex-row items-center justify-between">
<div class="mb-4 sm:mb-0">
<h3 class="text-lg font-medium text-white">Sign in to create 3D models</h3>
<p class="text-gray-300">New users get 10 free tokens to start</p>
</div>
<div class="flex space-x-3">
<button id="banner-login-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors">Login</button>
<button id="banner-signup-btn" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Sign Up</button>
</div>
</div>
</div>

<!-- 3D Modeling Studio Title -->
<div class="text-center mb-8">
  <div class="inline-block bg-gray-800 px-8 py-4 rounded-lg shadow-sm border border-gray-600">
    <h1 class="text-3xl font-bold text-white" style="font-family: 'Poppins', 'Inter', sans-serif;">
      3D MODELING <span style="color: #f97316;">STUDIO</span>
    </h1>
  </div>
</div>

<!-- App section -->
<section id="app-section" class="space-y-6">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<!-- Left panel: Input controls -->
<div class="bg-gray-800 p-6 rounded-lg border border-gray-600 shadow-sm">
<h2 class="text-xl font-semibold mb-4 text-white">Create 3D Model</h2>

<!-- Input options -->
<div class="mb-4">
<div class="flex space-x-2 mb-2">
<button id="upload-option" class="flex-1 px-3 py-2 bg-orange-500 rounded-md text-white hover:bg-orange-600 transition-colors">Upload Image</button>
<button id="text-option" class="flex-1 px-3 py-2 rounded-md text-gray-300 border border-gray-600 hover:bg-gray-700 transition-colors">Text Description</button>
</div>

<!-- Image upload input -->
<div id="upload-input" class="mb-3">
<div class="mt-2 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-600 border-dashed rounded-md hover:border-orange-500 transition-colors" id="drop-zone">
<div class="space-y-1 text-center">
<svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
<path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
</svg>
<div class="flex justify-center text-sm">
<label class="file-input-wrapper relative cursor-pointer bg-orange-500 rounded-md font-medium text-white px-4 py-2 hover:bg-orange-600 transition-colors">
<span>Upload a file</span>
<input id="file-upload" name="file-upload" type="file" class="sr-only" accept="image/*">
</label>
</div>
<p id="file-name" class="text-xs text-gray-400 mt-2">PNG, JPG, WEBP up to 10MB</p>
</div>
</div>
<div id="image-preview-wrapper" class="mt-4 flex justify-center hidden">
<div class="image-preview-container">
<img id="image-preview" class="max-h-40 rounded" src="" alt="Preview">
<button type="button" class="delete-image-btn" id="delete-image">×</button>
</div>
</div>
</div>

<!-- Text description input -->
<div id="text-input" class="mb-3 hidden">
<textarea id="description" rows="4" class="text-base w-full px-3 py-2 bg-gray-700 text-white border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Describe your 3D model in detail (e.g. 'A detailed sculpture of a dragon with spread wings')..."></textarea>
</div>
</div>

<!-- Export format - Custom dropdown implementation -->
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-gray-300">Export Format</label>
<div class="custom-select-wrapper">
  <div class="custom-select">
    <div class="custom-select__trigger">
      <span id="selected-format">STL</span>
      <div class="custom-select__icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </div>
    </div>
    <div class="custom-options">
      <span class="custom-option selected" data-value="stl">STL</span>
      <span class="custom-option" data-value="obj">OBJ</span>
      <span class="custom-option" data-value="gltf">GLTF</span>
      <span class="custom-option" data-value="ply">PLY</span>
    </div>
  </div>
  <input type="hidden" id="export-format" name="export-format" value="stl">
</div>
</div>

<!-- Quality Settings -->
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-gray-300">Quality Level</label>
<div class="custom-select-wrapper">
  <div class="custom-select">
    <div class="custom-select__trigger">
      <span id="selected-quality">High Quality</span>
      <div class="custom-select__icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </div>
    </div>
    <div class="custom-options">
      <span class="custom-option" data-value="fast">Fast (Basic Quality)</span>
      <span class="custom-option selected" data-value="high">High Quality</span>
      <span class="custom-option" data-value="ultra">Ultra Quality</span>
    </div>
  </div>
  <input type="hidden" id="quality-level" name="quality-level" value="high">
</div>
</div>

<!-- Inference Steps -->
<div class="mb-4">
<label class="block text-sm font-medium mb-2 text-gray-300">Steps</label>
<div class="custom-select-wrapper">
  <div class="custom-select">
    <div class="custom-select__trigger">
      <span id="selected-steps">64 steps</span>
      <div class="custom-select__icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </div>
    </div>
    <div class="custom-options">
      <span class="custom-option" data-value="16">16 steps (Fast)</span>
      <span class="custom-option" data-value="32">32 steps (Balanced)</span>
      <span class="custom-option selected" data-value="64">64 steps (High Quality)</span>
      <span class="custom-option" data-value="128">128 steps (Ultra)</span>
    </div>
  </div>
  <input type="hidden" id="inference-steps" name="inference-steps" value="64">
</div>
</div>

<!-- Generate button and token counter -->
<div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
  <div class="flex space-x-2">
    <button id="generate-btn" class="px-5 py-3 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-md transition-colors button-orange">
      <span id="generate-text">Generate 3D Model</span>
      <span id="generating-text" class="hidden">
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Processing...
      </span>
    </button>
  </div>
  <div class="bg-gray-700 px-3 py-2 rounded-md text-sm flex items-center">
    <span class="mr-2 text-gray-300">Tokens remaining:</span>
    <span id="token-count" class="font-bold text-orange-400">-</span>
  </div>
</div>

<!-- AI Generation Logs -->
<div id="ai-logs" class="mt-4">
  <div class="flex justify-between items-center mb-2">
    <span class="text-sm font-medium text-gray-300">AI Generation Logs</span>
    <button id="toggle-logs-btn" class="text-xs text-orange-400 hover:text-orange-300 transition-colors">Expand</button>
  </div>
  <div id="logs-content"></div>
</div>
</div>

<!-- Right panel: 3D preview -->
<div class="bg-gray-800 p-6 rounded-lg border border-gray-600 shadow-sm h-full">
<div class="flex items-center justify-between mb-4">
  <h2 class="text-xl font-semibold text-orange-500">3D Preview</h2>
</div>
<div id="preview-container" class="w-full h-64 md:h-96 bg-black relative">
  <!-- Control buttons -->
  <div class="preview-controls">
    <button id="reset-view-btn" class="hover:bg-gray-600 transition-colors">Reset View</button>
    <button id="wireframe-btn" class="hover:bg-gray-600 transition-colors">Wireframe</button>
    <button id="fullscreen-btn" class="hover:bg-gray-600 transition-colors">Fullscreen</button>
  </div>

  <!-- 3D Canvas -->
  <div id="threejs-canvas" class="w-full h-full"></div>

  <!-- Bottom info -->
  <div class="preview-info">
    <div class="preview-instructions">
      Mouse: Rotate | Wheel: Zoom | Right-click: Pan
    </div>
    <div class="preview-stats">
      Vertices: <span id="vertex-count">24</span> &nbsp; Faces: <span id="face-count">12</span>
    </div>
  </div>



  <!-- Loading state -->
  <div id="loading-state" class="hidden eclipse-loading-container absolute inset-0">
    <div class="eclipse-animation">
      <div class="eclipse-glow"></div>
      <div class="eclipse-rim"></div>
      <div class="eclipse-circle">
        <div class="eclipse-inner-shadow"></div>
      </div>
    </div>
    <div class="loading-text">Generating 3D Model...</div>
  </div>
</div>

<!-- Download options - initially hidden -->
<div id="download-options" class="mt-4 hidden">
<div class="flex flex-col sm:flex-row justify-between space-y-3 sm:space-y-0 sm:space-x-3">
<button id="download-btn" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors flex items-center justify-center">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
</svg>
<span id="download-format">Download STL</span>
</button>
<button id="reset-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors">
Start New Model
</button>
</div>
</div>
</div>
</div>
</section>

<!-- Dashboard section - initially hidden -->
<section id="dashboard-section" class="hidden space-y-6">
<div class="bg-gray-800 p-6 rounded-lg border border-gray-600 shadow-sm">
<h2 class="text-2xl font-semibold mb-6 text-white">User Dashboard</h2>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
<div class="bg-gray-700 p-4 rounded-lg shadow-sm">
<h3 class="text-lg font-medium mb-2 text-white">Tokens</h3>
<div class="flex justify-between items-end">
<div class="text-3xl font-bold text-orange-400" id="dashboard-token-count">-</div>
<button id="buy-tokens-btn" class="text-sm px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Buy More</button>
</div>
</div>

<div class="bg-gray-700 p-4 rounded-lg shadow-sm">
<h3 class="text-lg font-medium mb-2 text-white">Subscription</h3>
<div class="flex justify-between items-end">
<div id="subscription-tier" class="text-xl font-bold text-gray-300">Free Tier</div>
<button id="upgrade-btn" class="text-sm px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Upgrade</button>
</div>
</div>

<div class="bg-gray-700 p-4 rounded-lg shadow-sm">
<h3 class="text-lg font-medium mb-2 text-white">Models Created</h3>
<div id="models-created-count" class="text-3xl font-bold text-gray-300">0</div>
</div>
</div>

<div class="bg-gray-800 p-4 rounded-lg border border-gray-600 shadow-sm">
<h3 class="text-lg font-medium mb-4 text-white">Recent Models</h3>
<div id="recent-models-empty" class="text-center text-gray-400 py-8">
<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
</svg>
<p>You haven't created any models yet</p>
<button id="create-first-model" class="mt-4 px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Create Your First Model</button>
</div>
<div id="recent-models-list" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
<!-- Models will be added here dynamically -->
</div>
</div>
</div>
</section>

<!-- Pricing section - initially hidden -->
<section id="pricing-section" class="hidden space-y-6">
<div class="bg-gray-800 p-6 rounded-lg border border-gray-600 shadow-sm">
<h2 class="text-2xl font-semibold mb-2 text-white">Subscription Plans</h2>
<p class="text-gray-300 mb-6">Choose the plan that works best for you</p>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
<!-- Free Package -->
<div class="bg-gray-700 rounded-lg overflow-hidden border-2 border-orange-500">
<div class="p-6">
<h3 class="text-xl font-bold mb-2 text-white">Free Package</h3>
<div class="mb-4">
<span class="text-3xl font-bold text-white">$0</span>
<span class="text-gray-400">/month</span>
</div>
<ul class="space-y-2 mb-6">
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">10 free tokens</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">Basic resolution models</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">1 export format (STL)</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">Community support</span>
</li>
</ul>
<button id="free-plan-btn" data-plan="free" data-checkout-id="" class="w-full py-2 bg-orange-500 text-white rounded-md transition-colors cursor-default">
  Subscribe
</button>
</div>
</div>

<!-- Basic Package -->
<div class="bg-gray-700 rounded-lg overflow-hidden border-2 border-orange-500">
<div class="p-6">
<h3 class="text-xl font-bold mb-2 text-white">Basic Package</h3>
<div class="mb-4">
<span class="text-3xl font-bold text-white">$2.99</span>
<span class="text-gray-400">/month</span>
</div>
<ul class="space-y-2 mb-6">
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">50 tokens per month</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">Standard resolution models</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">3 export formats</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">Email support</span>
</li>
</ul>
<button id="basic-plan-btn" data-plan="basic" data-checkout-id="STRIPE_BASIC_CHECKOUT_ID" class="w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn">
  Subscribe
</button>
</div>
</div>

<!-- Silver Package -->
<div class="bg-gray-700 rounded-lg overflow-hidden border-2 border-orange-500 relative">
<div class="absolute top-0 right-0 bg-orange-500 text-white px-4 py-1 text-sm font-bold">
POPULAR
</div>
<div class="p-6">
<h3 class="text-xl font-bold mb-2 text-white">Silver Package</h3>
<div class="mb-4">
<span class="text-3xl font-bold text-white">$5.99</span>
<span class="text-gray-400">/month</span>
</div>
<ul class="space-y-2 mb-6">
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">200 tokens per month</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">High resolution models</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">All export formats</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">Priority support</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">Texture mapping</span>
</li>
</ul>
<button id="silver-plan-btn" data-plan="silver" data-checkout-id="STRIPE_SILVER_CHECKOUT_ID" class="w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn">
  Subscribe
</button>
</div>
</div>

<!-- Gold Package -->
<div class="bg-gray-700 rounded-lg overflow-hidden border-2 border-orange-500">
<div class="p-6">
<h3 class="text-xl font-bold mb-2 text-white">Gold Package</h3>
<div class="mb-4">
<span class="text-3xl font-bold text-white">$17.99</span>
<span class="text-gray-400">/month</span>
</div>
<ul class="space-y-2 mb-6">
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">1,000 tokens a month</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">Ultra-high resolution models</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">All export formats</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">24/7 dedicated support</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">Advanced texture mapping</span>
</li>
<li class="flex items-start">
<svg class="h-5 w-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
<span class="text-gray-300">API access</span>
</li>
</ul>
<button id="gold-plan-btn" data-plan="gold" data-checkout-id="STRIPE_GOLD_CHECKOUT_ID" class="w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn">
  Subscribe
</button>
</div>
</div>
</div>
</div>
</section>

<!-- Help/FAQ section - initially hidden -->
<section id="help-section" class="hidden space-y-6">
<div class="bg-gray-800 p-6 rounded-lg border border-gray-600 shadow-sm">
<h2 class="text-2xl font-semibold mb-6 text-white">Help & FAQs</h2>

<div class="space-y-4 mb-8">
<div class="border-b border-gray-600 pb-4">
<h3 class="text-lg font-medium mb-2 text-white">How does 3DREAM LABS work?</h3>
<p class="text-gray-300">3DREAM LABS uses advanced AI algorithms to convert 2D images or text descriptions into detailed 3D models. Our technology analyzes the input and creates a three-dimensional representation that can be exported in various formats for 3D printing, game development, or other applications.</p>
</div>

<div class="border-b border-gray-600 pb-4">
<h3 class="text-lg font-medium mb-2 text-white">What are tokens and how do they work?</h3>
<p class="text-gray-300">Tokens are our platform's currency for generating 3D models. Each model generation costs one token. New users receive 10 free tokens to try the service. Additional tokens can be purchased individually or obtained through monthly subscriptions.</p>
</div>

<div class="border-b border-gray-600 pb-4">
<h3 class="text-lg font-medium mb-2 text-white">What file formats are supported?</h3>
<p class="text-gray-300">3DREAM LABS supports exporting 3D models in STL, OBJ, GLTF, and PLY formats. The availability of certain formats depends on your subscription tier.</p>
</div>

<div class="border-b border-gray-600 pb-4">
<h3 class="text-lg font-medium mb-2 text-white">What types of images work best?</h3>
<p class="text-gray-300">For optimal results, use clear images with good lighting and a simple background. The object should be clearly visible and separated from the background. Multiple angles of the same object can produce better 3D models.</p>
</div>

<div class="border-b border-gray-600 pb-4">
<h3 class="text-lg font-medium mb-2 text-white">How detailed are the text descriptions for best results?</h3>
<p class="text-gray-300">Provide detailed descriptions including shape, size, proportions, textures, and colors. The more specific your description, the more accurate the 3D model will be. Example: "A rounded coffee mug with a handle, matte black finish, 4 inches tall with slight texture on the exterior."</p>
</div>

<div>
<h3 class="text-lg font-medium mb-2 text-white">What is the difference between subscription tiers?</h3>
<p class="text-gray-300">The Free package includes 10 tokens, basic resolution models, and 1 export format. The Basic package includes 50 tokens monthly, standard resolution models, and 3 export formats. Silver offers 200 tokens, higher resolution, all export formats, and texture mapping. Gold provides 1,000 tokens, ultra-high resolution, all features, and API access.</p>
</div>
</div>

<div class="bg-gray-700 p-4 rounded-lg shadow-sm">
<h3 class="text-lg font-medium mb-3 text-white">Still have questions?</h3>
<p class="text-gray-300 mb-4">Our support team is ready to help with any questions you may have about 3DREAM LABS.</p>
<button id="contact-support-btn" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors">Contact Support</button>
</div>
</div>
</section>

<!-- How It Works section - initially hidden -->
<section id="howitworks-section" class="hidden space-y-6">
  <div class="diagram-container">
    <h1 class="title">How It Works</h1>
    <div class="flow-grid">
      <!-- Step 1: User Action -->
      <div class="step-box step-1">
        <div class="step-number">1</div>
        <div class="step-icon">📱</div>
        <div class="step-title">User Uploads Image & Clicks "Generate"</div>
        <div class="step-description">User selects an image in 3Dream Labz app and clicks the Generate button</div>
      </div>
      <!-- Step 2: API Request -->
      <div class="step-box step-2">
        <div class="step-number">2</div>
        <div class="step-icon">☁️</div>
        <div class="step-title">API Request to Server</div>
        <div class="step-description">App sends /generate request with base64 encoded image to ngrok tunnel URL</div>
      </div>
      <!-- Step 3: Background Removal -->
      <div class="step-box step-3">
        <div class="step-number">3</div>
        <div class="step-icon">🎭</div>
        <div class="step-title">Background Removal</div>
        <div class="step-description">BackgroundRemover cleans up the image by removing the background</div>
      </div>
      <!-- Step 4: 3D Shape Generation -->
      <div class="step-box step-4">
        <div class="step-number">4</div>
        <div class="step-icon">🧊</div>
        <div class="step-title">3D Shape Generation</div>
        <div class="step-description">Hunyuan3DDiTFlowMatchingPipeline creates the 3D mesh structure</div>
      </div>
      
      <!-- 3DREAM LABZ Center Text -->
      <div class="dream-center">
        <div class="particles" id="particles"></div>
        <div class="dream-text" id="dreamText">3DREAM LABZ</div>
      </div>
      
      <!-- Step 5: Texture Application -->
      <div class="step-box step-5">
        <div class="step-number">5</div>
        <div class="step-icon">🎨</div>
        <div class="step-title">Texture Application</div>
        <div class="step-description">Hunyuan3DPaintPipeline applies realistic textures to the 3D model</div>
        <div class="fallback-note">⚡ GPU/CPU fallback</div>
      </div>
      <!-- Step 6: STL Conversion -->
      <div class="step-box step-6">
        <div class="step-number">6</div>
        <div class="step-icon">📦</div>
        <div class="step-title">STL Conversion</div>
        <div class="step-description">Converts final mesh to STL format and base64 encodes for transfer</div>
      </div>
      <!-- Step 7: API Response -->
      <div class="step-box step-7">
        <div class="step-number">7</div>
        <div class="step-icon">☁️</div>
        <div class="step-title">API Response</div>
        <div class="step-description">Server sends /generate response with base64 encoded STL file back to the app</div>
      </div>
      <!-- Step 8: Final Result -->
      <div class="step-box step-8">
        <div class="step-number">8</div>
        <div class="step-icon">🎯</div>
        <div class="step-title">Download & View 3D Model</div>
        <div class="step-description">User downloads and views the completed 3D model in the app</div>
      </div>
    </div>
  </div>
</section>
</main>
</div>

<!-- Hidden 3D model viewer for fullscreen -->
<div id="model-viewer" style="display: none;"></div>

<script>
// Initialize variables for generation counting and rating check
let generationCount = 0;
let hasRated = false;
let processingTimer = null;
let processingStartTime = 0;

// Backend API endpoint - using local server
const API_URL = 'https://0e0875688040.ngrok-free.app';
console.log("API URL configured as:", API_URL);

// Store the current 3D model for export
let currentModel = null;

// Initialize Three.js scene for 3D preview
let scene, camera, renderer, controls, cube, animationId;
let isWireframe = false;
let isFullscreen = false;
let currentGrid = null;

// Initialize Three.js
function initThreeJS() {
  try {
    // Create scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    
    // Create camera
    const container = document.getElementById('threejs-canvas');
    const containerRect = container.getBoundingClientRect();
    camera = new THREE.PerspectiveCamera(75, containerRect.width / containerRect.height, 0.1, 1000);
    camera.position.set(4, 4, 4);
    
    // Create renderer
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(containerRect.width, containerRect.height);
    renderer.setClearColor(0x000000, 1);
    container.appendChild(renderer.domElement);
    
    // Add lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 10, 5);
    scene.add(directionalLight);
    
    const backLight = new THREE.DirectionalLight(0xffffff, 0.3);
    backLight.position.set(-10, -10, -5);
    scene.add(backLight);
    
    // Add grid
    createGrid();
    
    // Create demo cube
    createDemoCube();
    
    // Add orbit controls
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.enablePan = true;
    controls.enableZoom = true;
    controls.enableRotate = true;
    
    // Handle window resize
    window.addEventListener('resize', onWindowResize);
    
    // Start render loop
    animate();
    
    console.log("Three.js initialized successfully");
  } catch (e) {
    console.error("Error initializing Three.js:", e);
  }
}

// Create grid
function createGrid() {
  const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x444444);
  scene.add(gridHelper);
  currentGrid = gridHelper;
}

// Create demo cube (orange cube like in the image)
function createDemoCube() {
  const geometry = new THREE.BoxGeometry(2, 2, 2);
  const material = new THREE.MeshStandardMaterial({ 
    color: 0xf97316, // Orange color
    metalness: 0.3,
    roughness: 0.4
  });
  
  cube = new THREE.Mesh(geometry, material);
  cube.position.set(0, 1, 0); // Position above the grid
  scene.add(cube);
  
  // Update stats
  updateStats(geometry);
}

// Update vertex and face count
function updateStats(geometry) {
  const vertices = geometry.attributes.position.count;
  const faces = geometry.index ? geometry.index.count / 3 : vertices / 3;
  
  document.getElementById('vertex-count').textContent = vertices;
  document.getElementById('face-count').textContent = Math.floor(faces);
}

// Handle window resize
function onWindowResize() {
  if (!camera || !renderer) return;
  
  const container = document.getElementById('threejs-canvas');
  if (!container) return;
  
  const containerRect = container.getBoundingClientRect();
  camera.aspect = containerRect.width / containerRect.height;
  camera.updateProjectionMatrix();
  renderer.setSize(containerRect.width, containerRect.height);
}

// Animation loop
function animate() {
  animationId = requestAnimationFrame(animate);
  
  if (controls) controls.update();
  if (renderer && scene && camera) {
    renderer.render(scene, camera);
  }
}

// 3D Preview Control Functions
function resetView() {
  if (camera && controls) {
    camera.position.set(4, 4, 4);
    camera.lookAt(0, 0, 0);
    controls.reset();
  }
}

function toggleWireframe() {
  if (!cube) return;
  
  isWireframe = !isWireframe;
  
  if (cube.material) {
    cube.material.wireframe = isWireframe;
  }
  
  // Update button appearance
  const wireframeBtn = document.getElementById('wireframe-btn');
  if (wireframeBtn) {
    if (isWireframe) {
      wireframeBtn.classList.add('active');
    } else {
      wireframeBtn.classList.remove('active');
    }
  }
}

function toggleFullscreen() {
  const previewContainer = document.getElementById('preview-container');
  
  if (!isFullscreen) {
    // Enter fullscreen
    previewContainer.classList.add('fullscreen-viewer');
    isFullscreen = true;
    
    // Update renderer size for fullscreen
    setTimeout(() => {
      if (renderer) {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      }
    }, 100);
    
    // Update button text
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    if (fullscreenBtn) {
      fullscreenBtn.textContent = 'Exit Fullscreen';
      fullscreenBtn.classList.add('active');
    }
  } else {
    // Exit fullscreen
    previewContainer.classList.remove('fullscreen-viewer');
    isFullscreen = false;
    
    // Restore normal size
    setTimeout(() => {
      onWindowResize();
    }, 100);
    
    // Update button text
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    if (fullscreenBtn) {
      fullscreenBtn.textContent = 'Fullscreen';
      fullscreenBtn.classList.remove('active');
    }
  }
}

// Global variable to store the uploaded image as base64
window.uploadedImageBase64 = null;

// Handle image upload and convert to base64
function handleImageUpload(file) {
    if (!file || !file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        // Remove the data:image/...;base64, prefix if present
        const base64Image = e.target.result.split(',')[1];
        window.uploadedImageBase64 = base64Image;
        // Optionally update the UI to show the image preview
        const preview = document.getElementById('uploaded-image-preview');
        if (preview) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        }
    };
    reader.readAsDataURL(file);
}

// Attach the handler to your file input
const fileInput = document.getElementById('image-upload');
if (fileInput) {
    fileInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            handleImageUpload(e.target.files[0]);
        }
    });
}

// Update callBackendAPI to always send the image if available
async function callBackendAPI(prompt, format = 'stl', image = null) {
    try {
        logToUI("Calling backend API...", "info");
        // Gather steps and quality from UI
        const stepsRaw = document.getElementById('inference-steps')?.value;
        const steps = stepsRaw ? parseInt(stepsRaw, 10) : 64;
        const quality = document.getElementById('quality-level')?.value || 'high';
        console.log('[DEBUG] callBackendAPI called with:', { prompt, format, steps, quality, hasImage: !!image });
        const requestBody = {
            prompt: prompt,
            num_inference_steps: steps,
            quality: quality,
        };
        // Use the provided image or the globally stored one
        const base64Image = image || window.uploadedImageBase64;
        if (base64Image) {
            requestBody.image = base64Image;
        }

        const response = await fetch(`${API_URL}/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API error: ${response.status} ${response.statusText}. Response: ${errorText}`);
        }

        const data = await response.json();
        return data;

    } catch (error) {
        console.error('Full error in callBackendAPI:', error);
        logToUI(`Frontend Error: ${error.message}`, "error");
        throw error;
    }
}

// When generating a model, always pass the base64 image
async function generateAIModel() {
    try {
        startProcessingTimer(); // Start the seconds counter!
        const prompt = document.getElementById('description').value;
        const format = document.getElementById('export-format').value;
        const steps = parseInt(document.getElementById('inference-steps')?.value || '64', 10);
        // Use the globally stored base64 image
        const imageBase64 = window.uploadedImageBase64 || null;
        console.log(`[DEBUG] generateAIModel -> steps: ${steps}`);
        const result = await callBackendAPI(prompt, format, imageBase64);
        await handleAIResponse(result);
    } catch (error) {
        logToUI(`Error generating AI model: ${error.message}`, "error");
        stopProcessingTimer(); // Stop the timer on error
    }
}

// Handle Point-E responses and load 3D model files (UPDATED)
async function handleAIResponse(result) {
    try {
        console.log('Starting handleAIResponse with result:', result);
        console.log('Result type:', typeof result);
        console.log('Result keys:', Object.keys(result));
        console.log('Full result:', JSON.stringify(result, null, 2));
        
        if (!result) {
            logToUI("Empty response from server", "error");
            return;
        }
        
        logToUI("Processing server response...", "info");
        
        // Check for success and model_data
        if (result.success && result.model_data) {
            logToUI("Received model data, processing...", "success");
            
            try {
                console.log('Converting base64 to blob...');
                // Convert base64 to blob
                const binaryString = atob(result.model_data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/octet-stream' });
                
                console.log('Creating model URL...');
                // Create URL for the blob
                const modelUrl = URL.createObjectURL(blob);
                
                console.log('Loading model in 3D preview...');
                // Load the model in the 3D preview
                await loadSTLModel(modelUrl);
                
                logToUI("✅ 3D model generated successfully!", "success");
                return;
            } catch (error) {
                console.error('Error processing model data:', error);
                logToUI(`Error processing model data: ${error.message}`, "error");
                throw error;
            }
        } else if (result.stl_data) {
            // Handle direct STL data
            try {
                console.log('Processing STL data...');
                console.log('STL data type:', typeof result.stl_data);
                console.log('STL data length:', result.stl_data.length);
                
                const blob = new Blob([result.stl_data], { type: 'application/octet-stream' });
                const modelUrl = URL.createObjectURL(blob);
                console.log('Created model URL:', modelUrl);
                
                await loadSTLModel(modelUrl);
                logToUI("✅ 3D model generated successfully!", "success");
                return;
            } catch (error) {
                console.error('Error processing STL data:', error);
                logToUI(`Error processing STL data: ${error.message}`, "error");
                throw error;
            }
        } else if (result.data) {
            // Handle Hunyuan3D response format
            try {
                console.log('Processing Hunyuan3D data...');
                logToUI("Processing Hunyuan3D response...", "info");
                
                if (result.data.stl_data) {
                    const blob = new Blob([result.data.stl_data], { type: 'application/octet-stream' });
                    const modelUrl = URL.createObjectURL(blob);
                    console.log('Created model URL from Hunyuan3D data');
                    
                    await loadSTLModel(modelUrl);
                    logToUI("✅ 3D model generated successfully!", "success");
                    return;
                } else if (result.data.model_data) {
                    // Handle base64 encoded model data
                    const binaryString = atob(result.data.model_data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    const blob = new Blob([bytes], { type: 'application/octet-stream' });
                    const modelUrl = URL.createObjectURL(blob);
                    
                    await loadSTLModel(modelUrl);
                    logToUI("✅ 3D model generated successfully!", "success");
                    return;
                }
            } catch (error) {
                console.error('Error processing Hunyuan3D data:', error);
                logToUI(`Error processing Hunyuan3D data: ${error.message}`, "error");
                throw error;
            }
        } else if (result.stl_file) {
            // Handle STL file path response
            try {
                console.log('Processing STL file path...');
                logToUI("Processing STL file...", "info");
                
                // Fetch the STL file from the backend
                const stlResponse = await fetch(`${API_URL}/download/${result.stl_file}`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (!stlResponse.ok) {
                    throw new Error(`Failed to fetch STL file: ${stlResponse.status}`);
                }
                
                const stlBlob = await stlResponse.blob();
                const modelUrl = URL.createObjectURL(stlBlob);
                
                await loadSTLModel(modelUrl);
                logToUI("✅ 3D model generated successfully!", "success");
                return;
            } catch (error) {
                console.error('Error processing STL file:', error);
                logToUI(`Error processing STL file: ${error.message}`, "error");
                throw error;
            }
        } else {
            console.error('Invalid response format:', result);
            logToUI(`Unknown response format. Keys: ${Object.keys(result).join(', ')}`, "error");
            throw new Error("No valid model data found in response");
        }
    } catch (error) {
        console.error('Error in handleAIResponse:', error);
        logToUI(`Error processing response: ${error.message}`, "error");
        
        // Keep the demo cube on error
        logToUI("Keeping demo cube visible", "info");
    }
}

// Load STL model into the 3D preview
async function loadSTLModel(modelUrl) {
    try {
        logToUI("Loading STL model into 3D preview...", "info");
        
        // Remove current cube
        if (cube) {
            scene.remove(cube);
            cube = null;
        }
        
        // Load STL file
        const loader = new THREE.STLLoader();
        
        // Fetch and parse the STL file
        const response = await fetch(modelUrl);
        const arrayBuffer = await response.arrayBuffer();
        const geometry = loader.parse(arrayBuffer);
        
        // Create material (preserve wireframe state)
        const material = new THREE.MeshStandardMaterial({ 
            color: 0xf97316, // Orange color
            metalness: 0.3,
            roughness: 0.4,
            wireframe: isWireframe
        });
        
        // Create mesh
        cube = new THREE.Mesh(geometry, material);
        
        // Center and scale the model
        geometry.computeBoundingBox();
        const box = geometry.boundingBox;
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        
        // Center the geometry
        geometry.translate(-center.x, -center.y, -center.z);
        
        // Scale to fit in view (max size of 4 units)
        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 4 / maxDim;
        cube.scale.set(scale, scale, scale);
        
        // Position above the grid
        cube.position.set(0, size.y * scale / 2, 0);
        
        // Add to scene
        scene.add(cube);
        
        // Update stats
        updateStats(geometry);
        
        // Update UI
        showModelGenerated();
        
        logToUI("STL model loaded successfully!", "success");
        
    } catch (error) {
        console.error('Error loading STL model:', error);
        logToUI(`Error loading STL model: ${error.message}`, "error");
        
        // Fallback to demo cube
        createDemoCube();
    }
}

// Show UI state when model is generated
function showModelGenerated() {
    // Hide loading state
    const loadingState = document.getElementById('loading-state');
    const initialState = document.getElementById('initial-state');
    const generateText = document.getElementById('generate-text');
    const generatingText = document.getElementById('generating-text');
    const downloadOptions = document.getElementById('download-options');
    
    if (loadingState) loadingState.classList.add('hidden');
    if (initialState) initialState.classList.add('hidden');
    if (generateText) generateText.classList.remove('hidden');
    if (generatingText) generatingText.classList.add('hidden');
    if (downloadOptions) downloadOptions.classList.remove('hidden');
    
    // Stop processing timer
    stopProcessingTimer();
}

// Start processing timer
function startProcessingTimer() {
  processingStartTime = Date.now();
  const processingCounter = document.getElementById('processing-counter');
  
  processingTimer = setInterval(() => {
    const elapsed = (Date.now() - processingStartTime) / 1000;
    if (processingCounter) {
      processingCounter.textContent = `processing | ${elapsed.toFixed(1)}/60s`;
    }
  }, 100);
}

// Stop processing timer
function stopProcessingTimer() {
  if (processingTimer) {
    clearInterval(processingTimer);
    processingTimer = null;
  }
}

// Log to the AI logs area
function logToUI(message, type = 'info') {
  try {
    const logsContent = document.getElementById('logs-content');
    if (!logsContent) return;
    
    // Get current timestamp
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    
    // Create log entry
    const logLine = document.createElement('div');
    logLine.className = 'log-line';
    
    // Time
    const timeSpan = document.createElement('span');
    timeSpan.className = 'log-time';
    timeSpan.textContent = `[${timeStr}]`;
    logLine.appendChild(timeSpan);
    
    // Message with appropriate class
    const msgSpan = document.createElement('span');
    msgSpan.className = `log-${type}`;
    msgSpan.textContent = message;
    logLine.appendChild(msgSpan);
    
    // Add to logs
    logsContent.appendChild(logLine);
    
    // Scroll to bottom
    logsContent.scrollTop = logsContent.scrollHeight;
  } catch (e) {
    console.error("Error writing to log UI:", e);
  }
}

// Check if user has already rated the app
function checkIfUserHasRated() {
  try {
    if (!currentUser || !db) return false;
    
    return new Promise(async (resolve) => {
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          resolve(userData.hasRated === true);
        } else {
          resolve(false);
        }
      } catch (error) {
        console.error("Error checking if user has rated:", error);
        resolve(false); // On error, assume they haven't rated
      }
    });
  } catch (e) {
    console.error("Error in checkIfUserHasRated:", e);
    return false;
  }
}

// Show rating modal
async function showRatingModal() {
  if (!currentUser) return;
  
  // Check if user has already rated
  hasRated = await checkIfUserHasRated();
  if (hasRated) return;
  
  // Display the rating modal
  document.getElementById('rating-modal').style.display = 'flex';
}

// Save rating to Firebase
async function saveRating(rating, feedback) {
  try {
    if (!currentUser || !db) return;
    
    // Create feedback document
    const feedbackData = {
      userId: currentUser.uid,
      userEmail: currentUser.email,
      rating: rating,
      feedback: feedback || "",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    // Add to feedback collection
    await db.collection('feedback').add(feedbackData);
    
    // Mark user as having rated
    await db.collection('users').doc(currentUser.uid).update({
      hasRated: true
    });
    
    console.log("Rating saved successfully");
    hasRated = true;
    
  } catch (error) {
    console.error("Error saving rating:", error);
  }
}

// Global navigation functions
function showSection(sectionName) {
  // Hide all sections
  const sections = ['app', 'dashboard', 'pricing', 'help', 'howitworks'];
  sections.forEach(section => {
    const sectionElement = document.getElementById(`${section}-section`);
    if (sectionElement) sectionElement.classList.add('hidden');
    const btnElement = document.getElementById(`${section}-btn`);
    if (btnElement) btnElement.classList.remove('bg-orange-500', 'text-white');
    if (btnElement) btnElement.classList.add('text-gray-300', 'hover:bg-gray-700');
    // Also update mobile buttons
    const mobileBtnElement = document.getElementById(`mobile-${section}-btn`);
    if (mobileBtnElement) mobileBtnElement.classList.remove('bg-orange-500', 'text-white');
    if (mobileBtnElement) mobileBtnElement.classList.add('text-gray-300', 'hover:bg-gray-700');
  });
  // Show selected section
  const selectedSection = document.getElementById(`${sectionName}-section`);
  if (selectedSection) selectedSection.classList.remove('hidden');
  const selectedBtn = document.getElementById(`${sectionName}-btn`);
  if (selectedBtn) {
    selectedBtn.classList.remove('text-gray-300', 'hover:bg-gray-700');
    selectedBtn.classList.add('bg-orange-500', 'text-white');
  }
  // Also update mobile button
  const selectedMobileBtn = document.getElementById(`mobile-${sectionName}-btn`);
  if (selectedMobileBtn) {
    selectedMobileBtn.classList.remove('text-gray-300', 'hover:bg-gray-700');
    selectedMobileBtn.classList.add('bg-orange-500', 'text-white');
  }
  // Hide mobile menu after selection
  const mobileMenu = document.getElementById('mobile-menu');
  if (mobileMenu) mobileMenu.classList.add('hidden');
}

// Header scroll behavior
let lastScrollTop = 0;
const header = document.getElementById('mainHeader');

window.addEventListener('scroll', function() {
    let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    if (scrollTop > lastScrollTop && scrollTop > 100) {
        // Scrolling down
        header.classList.remove('header-visible');
        header.classList.add('header-hidden');
    } else {
        // Scrolling up
        header.classList.remove('header-hidden');
        header.classList.add('header-visible');
    }
    
    lastScrollTop = scrollTop;
});

// Profile dropdown toggle
function toggleProfileDropdown() {
  const dropdown = document.getElementById('profile-dropdown-menu');
  dropdown.classList.toggle('active');
}

// Auth modal functions
function showLoginModal() {
  document.getElementById('login-modal').style.display = 'flex';
  document.getElementById('signup-modal').style.display = 'none';
  document.getElementById('reset-password-modal').style.display = 'none';
  document.getElementById('edit-account-modal').style.display = 'none';
  document.getElementById('change-password-modal').style.display = 'none';
}

function showSignupModal() {
  document.getElementById('signup-modal').style.display = 'flex';
  document.getElementById('login-modal').style.display = 'none';
  document.getElementById('reset-password-modal').style.display = 'none';
  document.getElementById('edit-account-modal').style.display = 'none';
  document.getElementById('change-password-modal').style.display = 'none';
}

function showResetPasswordModal() {
  document.getElementById('reset-password-modal').style.display = 'flex';
  document.getElementById('login-modal').style.display = 'none';
  document.getElementById('signup-modal').style.display = 'none';
  document.getElementById('edit-account-modal').style.display = 'none';
  document.getElementById('change-password-modal').style.display = 'none';
  
  // Clear previous messages
  document.getElementById('reset-password-error').classList.add('hidden');
  document.getElementById('reset-password-success').classList.add('hidden');
}

function showEditAccountModal() {
  document.getElementById('edit-account-modal').style.display = 'flex';
  document.getElementById('login-modal').style.display = 'none';
  document.getElementById('signup-modal').style.display = 'none';
  document.getElementById('reset-password-modal').style.display = 'none';
  document.getElementById('change-password-modal').style.display = 'none';
  
  // Clear previous messages
  document.getElementById('edit-account-error').classList.add('hidden');
  document.getElementById('edit-account-success').classList.add('hidden');
  
  // Populate form with current user data
  if (currentUser) {
    document.getElementById('edit-fullname').value = currentUser.displayName || '';
    
    // Display current profile picture
    const profilePicImg = document.getElementById('edit-profile-pic-img');
    if (currentUser.photoURL) {
      profilePicImg.src = currentUser.photoURL;
      profilePicImg.classList.remove('hidden');
    } else {
      profilePicImg.classList.add('hidden');
    }
  }
}

function showChangePasswordModal() {
  document.getElementById('change-password-modal').style.display = 'flex';
  document.getElementById('edit-account-modal').style.display = 'none';
  document.getElementById('login-modal').style.display = 'none';
  document.getElementById('signup-modal').style.display = 'none';
  document.getElementById('reset-password-modal').style.display = 'none';
  
  // Clear previous messages and form
  document.getElementById('change-password-error').classList.add('hidden');
  document.getElementById('change-password-success').classList.add('hidden');
  document.getElementById('change-password-form').reset();
}

function hideAuthModals() {
  document.getElementById('login-modal').style.display = 'none';
  document.getElementById('signup-modal').style.display = 'none';
  document.getElementById('reset-password-modal').style.display = 'none';
  document.getElementById('edit-account-modal').style.display = 'none';
  document.getElementById('change-password-modal').style.display = 'none';
}

function showAlert(title, message) {
  const alertModal = document.getElementById('alert-modal');
  document.getElementById('alert-title').textContent = title;
  document.getElementById('alert-message').textContent = message;
  alertModal.style.display = 'flex';
}

// Function to show the out of tokens modal
function showOutOfTokensModal() {
  document.getElementById('out-of-tokens-modal').style.display = 'flex';
}

// Function to hide the out of tokens modal
function hideOutOfTokensModal() {
  document.getElementById('out-of-tokens-modal').style.display = 'none';
}

// Create user initials for profile avatar
function getInitials(name) {
  if (!name) return '?';
  
  const parts = name.split(' ');
  if (parts.length === 1) {
    return parts[0].charAt(0).toUpperCase();
  }
  return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
}

// Update profile avatar
function updateProfileAvatar() {
  const avatarContainer = document.getElementById('profile-avatar');
  if (!avatarContainer) return;
  
  // Clear existing content
  avatarContainer.innerHTML = '';
  
  if (currentUser && currentUser.photoURL) {
    // User has a profile picture
    const img = document.createElement('img');
    img.src = currentUser.photoURL;
    img.alt = "Profile";
    avatarContainer.appendChild(img);
  } else if (currentUser && currentUser.displayName) {
    // User has a name but no picture, show initials
    const initialsDiv = document.createElement('div');
    initialsDiv.className = 'profile-initials';
    initialsDiv.textContent = getInitials(currentUser.displayName);
    avatarContainer.appendChild(initialsDiv);
  } else if (currentUser) {
    // User has neither picture nor name, show email initial
    const initialsDiv = document.createElement('div');
    initialsDiv.className = 'profile-initials';
    initialsDiv.textContent = currentUser.email ? currentUser.email.charAt(0).toUpperCase() : '?';
    avatarContainer.appendChild(initialsDiv);
  } else {
    // No user logged in, show placeholder
    const initialsDiv = document.createElement('div');
    initialsDiv.className = 'profile-initials';
    initialsDiv.textContent = '?';
    avatarContainer.appendChild(initialsDiv);
  }
}

// Redirect to Stripe checkout URL - Updated to require login
function redirectToStripeCheckout(checkoutId) {
  try {
    // Check if user is logged in
    if (!currentUser) {
      showLoginModal();
      return;
    }
    
    const stripeURL = STRIPE_CHECKOUT_URLS[checkoutId] || checkoutId;
    window.location.href = stripeURL;
  } catch (error) {
    console.error("Error redirecting to Stripe:", error);
    showAlert("Checkout Error", "There was an error redirecting to the payment page. Please try again.");
  }
}

// Firebase initialization
let firebase_app = null;
let auth = null;
let db = null;
let storage = null;
let provider = null;
let currentUser = null;
const owners = [
  "dawud46meo@gmail.com"
]; // List of owner emails
let userIsOwner = false;

function initFirebase() {
  try {
    if (firebase_app) {
      console.log("Firebase already initialized");
      return;
    }
    
    console.log("Initializing Firebase...");
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA4ZLcY1mS9w4xpMnTGbuU_Ctd9f7fiUeQ",
      authDomain: "dream-labs3.firebaseapp.com",
      projectId: "dream-labs3",
      storageBucket: "dream-labs3.appspot.com",
      messagingSenderId: "190648590943",
      appId: "1:190648590943:web:230062095e51e3b4d271ea",
      measurementId: "G-X8Z8DQZLH9"
    };
    
    // Initialize Firebase
    firebase_app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    storage = firebase.storage();
    
    // Initialize Google Auth Provider
    provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({
      prompt: 'select_account'
    });
    
    // Set up authentication state change listener
    auth.onAuthStateChanged(user => {
      if (user) {
        // User is signed in
        currentUser = user;
        userIsOwner = owners.includes(user.email);
        updateUIForAuthState();
        
        // Try to create/update user document
        createOrUpdateUserDocument(user);
        
        // Check if user has already rated
        checkIfUserHasRated().then(rated => {
          hasRated = rated;
        });
      } else {
        // User is signed out
        currentUser = null;
        userIsOwner = false;
        updateUIForAuthState();
      }
    });
    
    console.log("Firebase initialized successfully");
  } catch (e) {
    console.error("Error initializing Firebase:", e);
    showAlert("Firebase Error", "There was an error connecting to Firebase. Please try again later.");
  }
}

// Create or update user document - with better error handling
async function createOrUpdateUserDocument(user) {
  try {
    // Set a timeout to prevent hanging
    const timeout = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Firestore timeout')), 10000)
    );
    
    // Try to get the document
    const docRef = db.collection('users').doc(user.uid);
    
    try {
      const doc = await Promise.race([docRef.get(), timeout]);
      
      // If the document doesn't exist, create it
      if (!doc.exists) {
        console.log("Creating new user document...");
        const userData = {
          email: user.email,
          displayName: user.displayName || '',
          fullName: user.displayName || '',
          photoURL: user.photoURL || '',
          tokens: 10,
          subscription: 'free',
          models: [],
          hasRated: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
          await Promise.race([docRef.set(userData), timeout]);
          console.log("User document created successfully!");
        } catch (error) {
          console.error("Error creating user document:", error);
          // Continue - auth still worked
          showAlert("Profile Setup Issue", "Your account is connected, but we had trouble saving your profile data due to possible connection issues. Some features may be limited.");
        }
      } else {
        console.log("User document already exists.");
      }
    } catch (error) {
      console.error("Error checking user document:", error);
      // Continue - auth still worked
      showAlert("Profile Setup Issue", "You're signed in, but we couldn't save your profile data due to possible connection issues. Some features may be limited.");
    }
  } catch (error) {
    console.error("Error in createOrUpdateUserDocument:", error);
    // Continue - auth still worked
    showAlert("Profile Setup Issue", "You're signed in, but we couldn't save your profile data. Some features may be limited until you're back online.");
  }
}

// Upload profile picture to Firebase Storage
async function uploadProfilePicture(file, userId) {
  try {
    if (!storage || !file) {
      throw new Error("Storage not initialized or no file provided");
    }
    
    // Create a storage reference
    const storageRef = storage.ref();
    const profilePicRef = storageRef.child(`profile_pictures/${userId}_${Date.now()}`);
    
    // Upload file
    const snapshot = await profilePicRef.put(file);
    
    // Get download URL
    const downloadURL = await snapshot.ref.getDownloadURL();
    return downloadURL;
  } catch (error) {
    console.error("Error uploading profile picture:", error);
    throw error;
  }
}

// Google sign-in function
async function signInWithGoogle() {
  try {
    // Show loading state
    const googleSigninText = document.getElementById('google-signin-text');
    const googleSigninLoading = document.getElementById('google-signin-loading');
    const googleSignupText = document.getElementById('google-signup-text');
    const googleSignupLoading = document.getElementById('google-signup-loading');
    
    if (googleSigninText) googleSigninText.textContent = "Connecting...";
    if (googleSigninLoading) googleSigninLoading.classList.remove('hidden');
    if (googleSignupText) googleSignupText.textContent = "Connecting...";
    if (googleSignupLoading) googleSignupLoading.classList.remove('hidden');
    
    // Initialize Firebase if needed
    if (!firebase_app) {
      initFirebase();
    }
    
    if (!auth || !provider) {
      throw new Error("Authentication services are not available");
    }

    // Set a timeout for the auth operation
    const authTimeout = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Authentication timeout')), 30000)
    );
    
    // Race the auth operation against the timeout
    const authResult = await Promise.race([
      auth.signInWithPopup(provider),
      authTimeout
    ]);
    
    const user = authResult.user;
    currentUser = user;
    userIsOwner = owners.includes(user.email);
    
    // Hide modals on success
    hideAuthModals();
    showAlert("Sign-in Successful", `Welcome, ${user.displayName || user.email}!`);
    updateUIForAuthState();
    
    return user;
  } catch (error) {
    console.error("Google Sign-In Error:", error);
    
    // Reset loading states
    const googleSigninText = document.getElementById('google-signin-text');
    const googleSigninLoading = document.getElementById('google-signin-loading');
    const googleSignupText = document.getElementById('google-signup-text');
    const googleSignupLoading = document.getElementById('google-signup-loading');
    
    if (googleSigninText) googleSigninText.textContent = "Sign in with Google";
    if (googleSigninLoading) googleSigninLoading.classList.add('hidden');
    if (googleSignupText) googleSignupText.textContent = "Sign up with Google";
    if (googleSignupLoading) googleSignupLoading.classList.add('hidden');
    
    // Handle specific errors
    let errorMessage = "Failed to sign in with Google";
    if (error.code === 'auth/popup-closed-by-user') {
      errorMessage = "Sign-in was cancelled";
    } else if (error.code === 'auth/popup-blocked') {
      errorMessage = "Pop-up was blocked by your browser. Please allow pop-ups for this site";
    } else if (error.code === 'auth/network-request-failed') {
      errorMessage = "Network error. Please check your internet connection";
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    showAlert("Sign-in Error", errorMessage);
    throw error;
  }
}

// Regular login function (email/password)
async function loginUser(email, password) {
  try {
    if (!auth) {
      throw new Error("Authentication not initialized");
    }
    
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    currentUser = user;
    userIsOwner = owners.includes(user.email);
    
    hideAuthModals();
    updateUIForAuthState();
    
    return user;
  } catch (error) {
    let errorMessage = "Failed to login";
    
    if (error.code === 'auth/user-not-found') {
      errorMessage = "No account found with this email";
    } else if (error.code === 'auth/wrong-password') {
      errorMessage = "Incorrect password";
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = "Invalid email format";
    } else if (error.code === 'auth/user-disabled') {
      errorMessage = "This account has been disabled";
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    throw new Error(errorMessage);
  }
}

// Sign up function (email/password) with additional profile data
async function createUser(email, password, confirmPassword, fullName, profilePicture) {
  // Validate password
  if (password.length < 6) {
    return Promise.reject(new Error('Password must be at least 6 characters'));
  }
  
  if (password !== confirmPassword) {
    return Promise.reject(new Error('Passwords do not match'));
  }
  
  try {
    if (!auth) {
      throw new Error("Authentication not initialized");
    }
    
    // Create user with email and password
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    // Check if user is owner
    userIsOwner = owners.includes(user.email);
    
    currentUser = user;
    
    // Additional information for profile
    let photoURL = '';
    
    // Upload profile picture if provided
    if (profilePicture) {
      try {
        photoURL = await uploadProfilePicture(profilePicture, user.uid);
      } catch (error) {
        console.error("Error uploading profile picture:", error);
        // Continue without picture
      }
    }
    
    // Update user profile
    await user.updateProfile({
      displayName: fullName,
      photoURL: photoURL
    });
    
    // Create user document in Firestore
    if (db) {
      try {
        await db.collection('users').doc(user.uid).set({
          email: user.email,
          fullName: fullName,
          displayName: fullName,
          photoURL: photoURL,
          tokens: 10,
          subscription: 'free',
          models: [],
          hasRated: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error("Error saving user data to Firestore:", error);
        // User is still created, just without complete profile
      }
    }
    
    hideAuthModals();
    updateUIForAuthState();
    
    return user;
  } catch (error) {
    let errorMessage = "Failed to create account";
    
    if (error.code === 'auth/email-already-in-use') {
      errorMessage = "Email is already in use";
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = "Invalid email format";
    } else if (error.code === 'auth/weak-password') {
      errorMessage = "Password is too weak";
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    throw new Error(errorMessage);
  }
}

// Log out function
function logoutUser() {
  if (!auth) {
    console.error("Authentication not initialized");
    return;
  }
  
  auth.signOut().then(() => {
    currentUser = null;
    userIsOwner = false;
    updateUIForAuthState();
    showAlert("Logged Out", "You have been successfully logged out.");
  }).catch(error => {
    console.error("Error signing out:", error);
    showAlert("Logout Error", "Failed to sign out. Please try again.");
  });
}

// Send password reset email
async function sendPasswordResetEmail(email) {
  try {
    if (!auth) {
      throw new Error("Authentication not initialized");
    }
    
    await auth.sendPasswordResetEmail(email);
    return true;
  } catch (error) {
    let errorMessage = "Failed to send password reset email";
    
    if (error.code === 'auth/user-not-found') {
      errorMessage = "No account found with this email";
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = "Invalid email format";
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    throw new Error(errorMessage);
  }
}

// Update user profile function
async function updateUserProfile(fullName, profilePicture) {
  try {
    if (!auth || !currentUser) {
      throw new Error("Not authenticated");
    }
    
    let photoURL = currentUser.photoURL;
    
    // Upload new profile picture if provided
    if (profilePicture) {
      try {
        photoURL = await uploadProfilePicture(profilePicture, currentUser.uid);
      } catch (error) {
        console.error("Error uploading profile picture:", error);
        throw error;
      }
    }
    
    // Update Firebase Auth profile
    await currentUser.updateProfile({
      displayName: fullName,
      photoURL: photoURL
    });
    
    // Update Firestore document if available
    if (db) {
      try {
        await db.collection('users').doc(currentUser.uid).update({
          displayName: fullName,
          fullName: fullName,
          photoURL: photoURL
        });
      } catch (error) {
        console.error("Error updating Firestore document:", error);
        // Continue anyway since auth profile was updated
      }
    }
    
    // Update UI to reflect changes
    updateProfileAvatar();
    
    return true;
  } catch (error) {
    console.error("Error updating profile:", error);
    throw error;
  }
}

// Change password function
async function changeUserPassword(currentPassword, newPassword) {
  try {
    if (!auth || !currentUser) {
      throw new Error("Not authenticated");
    }
    
    // Re-authenticate user to verify current password
    const credential = firebase.auth.EmailAuthProvider.credential(
      currentUser.email,
      currentPassword
    );
    
    await currentUser.reauthenticateWithCredential(credential);
    
    // Update password
    await currentUser.updatePassword(newPassword);
    
    return true;
  } catch (error) {
    let errorMessage = "Failed to change password";
    
    if (error.code === 'auth/wrong-password') {
      errorMessage = "Current password is incorrect";
    } else if (error.code === 'auth/weak-password') {
      errorMessage = "New password is too weak";
    } else if (error.message) {
      errorMessage = error.message;
    }
    
    throw new Error(errorMessage);
  }
}

// Update UI based on auth state
function updateUIForAuthState() {
  try {
    const loggedOutElements = document.getElementById('logged-out-state');
    const loggedInElements = document.getElementById('logged-in-state');
    const loginRequiredBanner = document.getElementById('login-required-banner');

    
    // Update profile dropdown with user info
    const dropdownUserName = document.getElementById('dropdown-user-name');
    const dropdownUserEmail = document.getElementById('dropdown-user-email');
    
    if (currentUser) {
      // User is logged in
      if (loggedOutElements) loggedOutElements.classList.add('hidden');
      if (loggedInElements) loggedInElements.classList.remove('hidden');
      if (loginRequiredBanner) loginRequiredBanner.classList.add('hidden');
      
      // Update profile dropdown info
      if (dropdownUserName) dropdownUserName.textContent = currentUser.displayName || 'User';
      if (dropdownUserEmail) dropdownUserEmail.textContent = currentUser.email;
      
      // Update profile avatar
      updateProfileAvatar();
      
      // Owner gets unlimited credits automatically
      if (userIsOwner) {
        // Owner functionality - unlimited credits
      }
      
      // Default to app section when logged in
      if (document.getElementById('app-section').classList.contains('hidden')) {
        showSection('app');
      }
      
      // Try to display user data
      try {
        // Minimal user data if db is not accessible
        if (!db) {
          if (document.getElementById('token-count')) {
            document.getElementById('token-count').textContent = userIsOwner ? "∞" : "10";
          }
          if (document.getElementById('dashboard-token-count')) {
            document.getElementById('dashboard-token-count').textContent = userIsOwner ? "∞" : "10";
          }
          return;
        }
        
        // Try to get user data from Firestore
        const userDocRef = db.collection('users').doc(currentUser.uid);
        userDocRef.get().then(doc => {
          if (doc.exists) {
            const userData = doc.data();
            
            // Update token display
            if (userIsOwner) {
              if (document.getElementById('token-count')) {
                document.getElementById('token-count').textContent = "∞";
              }
              if (document.getElementById('dashboard-token-count')) {
                document.getElementById('dashboard-token-count').textContent = "∞";
              }
            } else {
              if (document.getElementById('token-count')) {
                document.getElementById('token-count').textContent = userData.tokens;
              }
              if (document.getElementById('dashboard-token-count')) {
                document.getElementById('dashboard-token-count').textContent = userData.tokens;
              }
            }
            
            // Update subscription tier
            if (document.getElementById('subscription-tier')) {
              document.getElementById('subscription-tier').textContent = 
                userData.subscription === 'free' ? 'Free Tier' :
                userData.subscription === 'basic' ? 'Basic Plan' :
                userData.subscription === 'silver' ? 'Silver Plan' :
                userData.subscription === 'gold' ? 'Gold Plan' : 'Free Tier';
            }
            
            // Update models count
            if (document.getElementById('models-created-count')) {
              document.getElementById('models-created-count').textContent = 
                userData.models ? userData.models.length : 0;
            }
            
            // Update hasRated status
            hasRated = userData.hasRated === true;
            
            // Update recent models
            const hasModels = userData.models && userData.models.length > 0;
            const recentModelsEmpty = document.getElementById('recent-models-empty');
            const recentModelsList = document.getElementById('recent-models-list');
            
            if (recentModelsEmpty && recentModelsList) {
              recentModelsEmpty.classList.toggle('hidden', hasModels);
              recentModelsList.classList.toggle('hidden', !hasModels);
              
              if (hasModels) {
                updateRecentModelsList(userData.models);
              }
            }
            
            // Update subscription buttons in pricing section based on current subscription
            updateSubscriptionButtons(userData.subscription);
          } else {
            // No document exists yet - show default values
            if (document.getElementById('token-count')) {
              document.getElementById('token-count').textContent = userIsOwner ? "∞" : "10";
            }
            if (document.getElementById('dashboard-token-count')) {
              document.getElementById('dashboard-token-count').textContent = userIsOwner ? "∞" : "10";
            }
            
            // Set default subscription as free
            updateSubscriptionButtons('free');
          }
        }).catch(error => {
          console.error("Error getting user data:", error);
          // Show default values on error
          if (document.getElementById('token-count')) {
            document.getElementById('token-count').textContent = userIsOwner ? "∞" : "10";
          }
          if (document.getElementById('dashboard-token-count')) {
            document.getElementById('dashboard-token-count').textContent = userIsOwner ? "∞" : "10";
          }
          
          // Set default subscription as free
          updateSubscriptionButtons('free');
        });
      } catch (e) {
        console.error("Error updating user data in UI:", e);
      }
    } else {
      // No user is logged in
      if (loggedOutElements) loggedOutElements.classList.remove('hidden');
      if (loggedInElements) loggedInElements.classList.add('hidden');
      if (loginRequiredBanner) loginRequiredBanner.classList.remove('hidden');
      
      // Reset token display
      if (document.getElementById('token-count')) {
        document.getElementById('token-count').textContent = "-";
      }
      if (document.getElementById('dashboard-token-count')) {
        document.getElementById('dashboard-token-count').textContent = "-";
      }
      
      // Reset subscription buttons - make all clickable when not logged in
      resetSubscriptionButtons();
    }
  } catch (e) {
    console.error("Error updating UI for auth state:", e);
  }
}

// Update subscription buttons based on current subscription
function updateSubscriptionButtons(subscription) {
  try {
    // Get all subscription buttons
    const freePlanBtn = document.getElementById('free-plan-btn');
    const basicPlanBtn = document.getElementById('basic-plan-btn');
    const silverPlanBtn = document.getElementById('silver-plan-btn');
    const goldPlanBtn = document.getElementById('gold-plan-btn');
    
    // Reset all buttons
    if (freePlanBtn) {
      freePlanBtn.className = "w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn";
      freePlanBtn.textContent = "Subscribe";
      freePlanBtn.disabled = false;
    }
    
    if (basicPlanBtn) {
      basicPlanBtn.className = "w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn";
      basicPlanBtn.textContent = "Subscribe";
      basicPlanBtn.disabled = false;
    }
    
    if (silverPlanBtn) {
      silverPlanBtn.className = "w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn";
      silverPlanBtn.textContent = "Subscribe";
      silverPlanBtn.disabled = false;
    }
    
    if (goldPlanBtn) {
      goldPlanBtn.className = "w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn";
      goldPlanBtn.textContent = "Subscribe";
      goldPlanBtn.disabled = false;
    }
    
    // Set current subscription button as unclickable 
    switch(subscription) {
      case 'free':
        if (freePlanBtn) {
          freePlanBtn.className = "w-full py-2 bg-gray-500 text-white rounded-md transition-colors cursor-default";
          freePlanBtn.textContent = "Current Plan";
          freePlanBtn.disabled = true;
          freePlanBtn.classList.remove('subscribe-btn');
        }
        break;
      case 'basic':
        if (basicPlanBtn) {
          basicPlanBtn.className = "w-full py-2 bg-gray-500 text-white rounded-md transition-colors cursor-default";
          basicPlanBtn.textContent = "Current Plan";
          basicPlanBtn.disabled = true;
          basicPlanBtn.classList.remove('subscribe-btn');
        }
        // Disable lower tier (free)
        if (freePlanBtn) {
          freePlanBtn.className = "w-full py-2 bg-gray-600 text-gray-400 rounded-md transition-colors cursor-not-allowed";
          freePlanBtn.textContent = "Lower Tier";
          freePlanBtn.disabled = true;
          freePlanBtn.classList.remove('subscribe-btn');
        }
        break;
      case 'silver':
        if (silverPlanBtn) {
          silverPlanBtn.className = "w-full py-2 bg-gray-500 text-white rounded-md transition-colors cursor-default";
          silverPlanBtn.textContent = "Current Plan";
          silverPlanBtn.disabled = true;
          silverPlanBtn.classList.remove('subscribe-btn');
        }
        // Disable lower tiers (free and basic)
        if (freePlanBtn) {
          freePlanBtn.className = "w-full py-2 bg-gray-600 text-gray-400 rounded-md transition-colors cursor-not-allowed";
          freePlanBtn.textContent = "Lower Tier";
          freePlanBtn.disabled = true;
          freePlanBtn.classList.remove('subscribe-btn');
        }
        if (basicPlanBtn) {
          basicPlanBtn.className = "w-full py-2 bg-gray-600 text-gray-400 rounded-md transition-colors cursor-not-allowed";
          basicPlanBtn.textContent = "Lower Tier";
          basicPlanBtn.disabled = true;
          basicPlanBtn.classList.remove('subscribe-btn');
        }
        break;
      case 'gold':
        if (goldPlanBtn) {
          goldPlanBtn.className = "w-full py-2 bg-gray-500 text-white rounded-md transition-colors cursor-default";
          goldPlanBtn.textContent = "Current Plan";
          goldPlanBtn.disabled = true;
          goldPlanBtn.classList.remove('subscribe-btn');
        }
        // Disable all lower tiers (free, basic, silver)
        if (freePlanBtn) {
          freePlanBtn.className = "w-full py-2 bg-gray-600 text-gray-400 rounded-md transition-colors cursor-not-allowed";
          freePlanBtn.textContent = "Lower Tier";
          freePlanBtn.disabled = true;
          freePlanBtn.classList.remove('subscribe-btn');
        }
        if (basicPlanBtn) {
          basicPlanBtn.className = "w-full py-2 bg-gray-600 text-gray-400 rounded-md transition-colors cursor-not-allowed";
          basicPlanBtn.textContent = "Lower Tier";
          basicPlanBtn.disabled = true;
          basicPlanBtn.classList.remove('subscribe-btn');
        }
        if (silverPlanBtn) {
          silverPlanBtn.className = "w-full py-2 bg-gray-600 text-gray-400 rounded-md transition-colors cursor-not-allowed";
          silverPlanBtn.textContent = "Lower Tier";
          silverPlanBtn.disabled = true;
          silverPlanBtn.classList.remove('subscribe-btn');
        }
        break;
    }
  } catch (e) {
    console.error("Error updating subscription buttons:", e);
  }
}

// Reset subscription buttons to default state (for logged out users)
function resetSubscriptionButtons() {
  try {
    const freePlanBtn = document.getElementById('free-plan-btn');
    const basicPlanBtn = document.getElementById('basic-plan-btn');
    const silverPlanBtn = document.getElementById('silver-plan-btn');
    const goldPlanBtn = document.getElementById('gold-plan-btn');
    
    if (freePlanBtn) {
      freePlanBtn.className = "w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn";
      freePlanBtn.textContent = "Subscribe";
      freePlanBtn.disabled = false;
    }
    
    if (basicPlanBtn) {
      basicPlanBtn.className = "w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn";
      basicPlanBtn.textContent = "Subscribe";
      basicPlanBtn.disabled = false;
    }
    
    if (silverPlanBtn) {
      silverPlanBtn.className = "w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn";
      silverPlanBtn.textContent = "Subscribe";
      silverPlanBtn.disabled = false;
    }
    
    if (goldPlanBtn) {
      goldPlanBtn.className = "w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors subscribe-btn";
      goldPlanBtn.textContent = "Subscribe";
      goldPlanBtn.disabled = false;
    }
  } catch (e) {
    console.error("Error resetting subscription buttons:", e);
  }
}

// Update recent models list
function updateRecentModelsList(models) {
  try {
    const container = document.getElementById('recent-models-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Take only the last 6 models and reverse the order (newest first)
    const recentModels = models.slice(-6).reverse();
    
    recentModels.forEach(model => {
      const modelCard = document.createElement('div');
      modelCard.className = 'bg-gray-700 p-3 rounded-lg border border-gray-600 shadow-sm';
      
      // Format date
      let formattedDate = "Unknown date";
      try {
        // Handle different timestamp formats
        if (model.timestamp) {
          if (typeof model.timestamp === 'object' && model.timestamp.toDate) {
            // Firestore Timestamp
            const date = model.timestamp.toDate();
            formattedDate = date.toLocaleDateString();
          } else if (typeof model.timestamp === 'number') {
            // Unix timestamp in milliseconds
            const date = new Date(model.timestamp);
            formattedDate = date.toLocaleDateString();
          }
        } else if (model.created) {
          if (typeof model.created === 'object' && model.created.toDate) {
            // Firestore Timestamp
            const date = model.created.toDate();
            formattedDate = date.toLocaleDateString();
          }
        }
      } catch (e) {
        console.error("Error formatting date:", e);
      }
      
      modelCard.innerHTML = `
        <div class="h-32 bg-gray-600 rounded flex items-center justify-center mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
          </svg>
        </div>
        <div class="text-sm truncate font-medium text-white" title="${model.name}">${model.name}</div>
        <div class="text-xs text-gray-400">${formattedDate}</div>
      `;
      
      container.appendChild(modelCard);
    });
  } catch (e) {
    console.error("Error updating recent models list:", e);
  }
}

// File handling functions
function handleFileUpload(file) {
  if (!file) return;
  
  const fileName = document.getElementById('file-name');
  if (fileName) fileName.textContent = file.name;
  
  // Create preview of uploaded image
  if (file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const imagePreview = document.getElementById('image-preview');
      const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
      
      if (imagePreview && imagePreviewWrapper) {
        imagePreview.src = e.target.result;
        imagePreviewWrapper.classList.remove('hidden');
      }

      // Store base64 string (remove prefix)
      window.uploadedImageBase64 = e.target.result.split(',')[1];
    };
    reader.readAsDataURL(file);
  }
}

function clearFileUpload() {
  const fileUpload = document.getElementById('file-upload');
  const fileName = document.getElementById('file-name');
  const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
  
  if (fileUpload) fileUpload.value = '';
  if (fileName) fileName.textContent = 'PNG, JPG, WEBP up to 10MB';
  if (imagePreviewWrapper) imagePreviewWrapper.classList.add('hidden');
  
  // Clear the global base64 image
  window.uploadedImageBase64 = null;
}

// Custom select/dropdown functionality
function initCustomSelects() {
  document.querySelectorAll('.custom-select__trigger').forEach(trigger => {
    trigger.addEventListener('click', function() {
      const customSelect = this.closest('.custom-select');
      customSelect.classList.toggle('open');
    });
  });
  
  // Close when clicking outside
  window.addEventListener('click', function(e) {
    const select = document.querySelector('.custom-select');
    if (!select) return;
    if (!select.contains(e.target)) {
      select.classList.remove('open');
    }
  });
  
  document.querySelectorAll('.custom-option').forEach(option => {
    option.addEventListener('click', function() {
      if (!this.classList.contains('selected')) {
        // Find previously selected option in this select and remove selected
        this.parentNode.querySelector('.custom-option.selected').classList.remove('selected');
        this.classList.add('selected');
        
        // Update the select trigger text
        const selectTrigger = this.closest('.custom-select').querySelector('.custom-select__trigger span');
        selectTrigger.textContent = this.textContent;
        
        // Update the hidden input value for this specific select
        const value = this.getAttribute('data-value');
        const wrapper = this.closest('.custom-select-wrapper');
        const hiddenInput = wrapper ? wrapper.querySelector('input[type="hidden"]') : null;
        if (hiddenInput) {
          hiddenInput.value = value;
          // If this is the export format select, also update download button label
          if (hiddenInput.id === 'export-format') {
            const downloadFormat = document.getElementById('download-format');
            if (downloadFormat) {
              downloadFormat.textContent = `Download ${value.toUpperCase()}`;
            }
          }
        }
        
        // Close the dropdown
        this.closest('.custom-select').classList.remove('open');
      }
    });
  });
}

// Check if user has enough tokens to generate a model
function hasEnoughTokens() {
  // If user is owner, they have unlimited tokens
  if (userIsOwner) return true;
  
  // Get the token count from the UI
  const tokenCountElement = document.getElementById('token-count');
  if (!tokenCountElement) return false;
  
  const tokenCount = parseInt(tokenCountElement.textContent);
  return !isNaN(tokenCount) && tokenCount > 0;
}

// Export 3D model in different formats (UPDATED)
function exportModel(format) {
  if (!cube) {
    showAlert('Export Error', 'No 3D model available to export.');
    return null;
  }
  
  try {
    let result = null;
    
    // Use appropriate exporter based on format
    switch (format.toLowerCase()) {
      case 'stl':
        const stlExporter = new THREE.STLExporter();
        result = stlExporter.parse(cube);
        return new Blob([result], { type: 'application/octet-stream' });
        
      case 'obj':
        const objExporter = new THREE.OBJExporter();
        result = objExporter.parse(cube);
        return new Blob([result], { type: 'text/plain' });
        
      case 'gltf':
        const gltfExporter = new THREE.GLTFExporter();
        return new Promise(resolve => {
          gltfExporter.parse(cube, (result) => {
            resolve(new Blob([JSON.stringify(result)], { type: 'application/json' }));
          }, { binary: false });
        });
        
      default:
        // Default to STL if format is not specifically handled
        const defaultExporter = new THREE.STLExporter();
        result = defaultExporter.parse(cube);
        return new Blob([result], { type: 'application/octet-stream' });
    }
  } catch (error) {
    console.error("Error exporting model:", error);
    return null;
  }
}

// Initialize app when document is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log("Document ready");
  
  try {
    // Initialize Three.js for 3D rendering
    initThreeJS();
  } catch (e) {
    console.error("Error initializing Three.js:", e);
  }
  
  try {
    // Initialize Firebase - but don't let errors block other functionality
    initFirebase();
  } catch (e) {
    console.error("Firebase initialization error:", e);
  }
  
  try {
    // Initialize custom select dropdowns
    initCustomSelects();
  } catch (e) {
    console.error("Error initializing custom selects:", e);
  }
  
  // 3D Preview Control Event Listeners
  const resetViewBtn = document.getElementById('reset-view-btn');
  if (resetViewBtn) {
    resetViewBtn.addEventListener('click', resetView);
  }
  
  const wireframeBtn = document.getElementById('wireframe-btn');
  if (wireframeBtn) {
    wireframeBtn.addEventListener('click', toggleWireframe);
  }
  
  const fullscreenBtn = document.getElementById('fullscreen-btn');
  if (fullscreenBtn) {
    fullscreenBtn.addEventListener('click', toggleFullscreen);
  }
  
  // Initialize the star rating system
  document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', function() {
      const value = this.getAttribute('data-value');
      
      // Reset all stars
      document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
      
      // Highlight stars up to this one
      document.querySelectorAll(`.star[data-value="${value}"]`).forEach(s => s.classList.add('active'));
      document.querySelectorAll(`.star[data-value="${parseInt(value)-1}"]`).forEach(s => s.classList.add('active'));
      document.querySelectorAll(`.star[data-value="${parseInt(value)-2}"]`).forEach(s => s.classList.add('active'));
      document.querySelectorAll(`.star[data-value="${parseInt(value)-3}"]`).forEach(s => s.classList.add('active'));
      document.querySelectorAll(`.star[data-value="${parseInt(value)-4}"]`).forEach(s => s.classList.add('active'));
      
      // Store selected rating
      document.getElementById('rating-modal').setAttribute('data-rating', value);
    });
  });
  
  // Rating submission
  const ratingSubmitBtn = document.getElementById('rating-submit');
  if (ratingSubmitBtn) {
    ratingSubmitBtn.addEventListener('click', async () => {
      const ratingModal = document.getElementById('rating-modal');
      const rating = parseInt(ratingModal.getAttribute('data-rating') || '0');
      const feedback = document.getElementById('rating-feedback').value.trim();
      
      if (rating === 0) {
        showAlert('Rating Required', 'Please select a rating before submitting.');
        return;
      }
      
      try {
        await saveRating(rating, feedback);
        ratingModal.style.display = 'none';
        showAlert('Thank You!', 'Your feedback has been submitted successfully.');
      } catch (error) {
        console.error("Error saving rating:", error);
        showAlert('Submission Error', 'There was an error submitting your rating. Please try again later.');
      }
    });
  }
  
  // Close rating modal
  const ratingCloseBtn = document.getElementById('rating-close');
  if (ratingCloseBtn) {
    ratingCloseBtn.addEventListener('click', () => {
      document.getElementById('rating-modal').style.display = 'none';
    });
  }
  
  // AI logs toggle
  const toggleLogsBtn = document.getElementById('toggle-logs-btn');
  const aiLogs = document.getElementById('ai-logs');
  
  if (toggleLogsBtn && aiLogs) {
    toggleLogsBtn.addEventListener('click', () => {
      aiLogs.classList.toggle('expanded');
      toggleLogsBtn.textContent = aiLogs.classList.contains('expanded') ? 'Collapse' : 'Expand';
    });
  }
  
  // All other event listeners (continuing from existing code)...
  
  // Login button in header
  const loginBtn = document.getElementById('login-btn');
  if (loginBtn) {
    loginBtn.addEventListener('click', () => {
      showLoginModal();
    });
  }
  
  // Sign up button in header
  const signupBtn = document.getElementById('signup-btn');
  if (signupBtn) {
    signupBtn.addEventListener('click', () => {
      showSignupModal();
    });
  }
  
  // Login button in banner
  const bannerLoginBtn = document.getElementById('banner-login-btn');
  if (bannerLoginBtn) {
    bannerLoginBtn.addEventListener('click', () => {
      showLoginModal();
    });
  }
  
  // Sign up button in banner
  const bannerSignupBtn = document.getElementById('banner-signup-btn');
  if (bannerSignupBtn) {
    bannerSignupBtn.addEventListener('click', () => {
      showSignupModal();
    });
  }
  
  // Go to signup button in login modal
  const goToSignupBtn = document.getElementById('go-to-signup');
  if (goToSignupBtn) {
    goToSignupBtn.addEventListener('click', () => {
      showSignupModal();
    });
  }
  
  // Go to login button in signup modal
  const goToLoginBtn = document.getElementById('go-to-login');
  if (goToLoginBtn) {
    goToLoginBtn.addEventListener('click', () => {
      showLoginModal();
    });
  }
  
  // Navigation buttons
  const appBtn = document.getElementById('app-btn');
  if (appBtn) {
    appBtn.addEventListener('click', () => {
      showSection('app');
    });
  }
  
  const dashboardBtn = document.getElementById('dashboard-btn');
  if (dashboardBtn) {
    dashboardBtn.addEventListener('click', () => {
      showSection('dashboard');
    });
  }
  
  const howItWorksBtn = document.getElementById('howitworks-btn');
  if (howItWorksBtn) {
    howItWorksBtn.addEventListener('click', () => {
      showSection('howitworks');
    });
  }
  
  const pricingBtn = document.getElementById('pricing-btn');
  if (pricingBtn) {
    pricingBtn.addEventListener('click', () => {
      showSection('pricing');
    });
  }
  
  const helpBtn = document.getElementById('help-btn');
  if (helpBtn) {
    helpBtn.addEventListener('click', () => {
      showSection('help');
    });
  }
  
  // Mobile navigation buttons
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', () => {
      const mobileMenu = document.getElementById('mobile-menu');
      if (mobileMenu) {
        mobileMenu.classList.toggle('hidden');
      }
    });
  }
  
  const mobileAppBtn = document.getElementById('mobile-app-btn');
  if (mobileAppBtn) {
    mobileAppBtn.addEventListener('click', () => {
      showSection('app');
    });
  }
  
  const mobileDashboardBtn = document.getElementById('mobile-dashboard-btn');
  if (mobileDashboardBtn) {
    mobileDashboardBtn.addEventListener('click', () => {
      showSection('dashboard');
    });
  }
  
  const mobileHowItWorksBtn = document.getElementById('mobile-howitworks-btn');
  if (mobileHowItWorksBtn) {
    mobileHowItWorksBtn.addEventListener('click', () => {
      showSection('howitworks');
    });
  }
  
  const mobilePricingBtn = document.getElementById('mobile-pricing-btn');
  if (mobilePricingBtn) {
    mobilePricingBtn.addEventListener('click', () => {
      showSection('pricing');
    });
  }
  
  const mobileHelpBtn = document.getElementById('mobile-help-btn');
  if (mobileHelpBtn) {
    mobileHelpBtn.addEventListener('click', () => {
      showSection('help');
    });
  }
  
  // Create first model button
  const createFirstModelBtn = document.getElementById('create-first-model');
  if (createFirstModelBtn) {
    createFirstModelBtn.addEventListener('click', () => {
      showSection('app');
    });
  }
  
  // Input type toggle buttons
  const uploadOption = document.getElementById('upload-option');
  const textOption = document.getElementById('text-option');
  
  if (uploadOption) {
    uploadOption.addEventListener('click', () => {
      uploadOption.classList.add('bg-orange-500', 'text-white');
      uploadOption.classList.remove('border', 'border-gray-600', 'text-gray-300');
      
      if (textOption) {
        textOption.classList.remove('bg-orange-500', 'text-white');
        textOption.classList.add('border', 'border-gray-600', 'text-gray-300');
      }
      
      const uploadInput = document.getElementById('upload-input');
      const textInput = document.getElementById('text-input');
      if (uploadInput) uploadInput.classList.remove('hidden');
      if (textInput) textInput.classList.add('hidden');
    });
  }
  
  if (textOption) {
    textOption.addEventListener('click', () => {
      textOption.classList.add('bg-orange-500', 'text-white');
      textOption.classList.remove('border', 'border-gray-600', 'text-gray-300');
      
      if (uploadOption) {
        uploadOption.classList.remove('bg-orange-500', 'text-white');
        uploadOption.classList.add('border', 'border-gray-600', 'text-gray-300');
      }
      
      const uploadInput = document.getElementById('upload-input');
      const textInput = document.getElementById('text-input');
      if (textInput) textInput.classList.remove('hidden');
      if (uploadInput) uploadInput.classList.add('hidden');
    });
  }
  
  // File upload
  const fileUpload = document.getElementById('file-upload');
  if (fileUpload) {
    fileUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFileUpload(file);
      }
    });
  }
  
  // Delete uploaded image
  const deleteImageBtn = document.getElementById('delete-image');
  if (deleteImageBtn) {
    deleteImageBtn.addEventListener('click', () => {
      clearFileUpload();
    });
  }
  
  // Handle file drag and drop
  const dropZone = document.getElementById('drop-zone');
  if (dropZone) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('border-orange-500');
      }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('border-orange-500');
      }, false);
    });
    
    dropZone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        const file = files[0];
        if (fileUpload) fileUpload.files = files;
        handleFileUpload(file);
      }
    }, false);
  }
  
  // Profile picture upload
  const profilePicPreview = document.getElementById('profile-pic-preview');
  const profilePicUpload = document.getElementById('profile-pic-upload');
  
  if (profilePicPreview && profilePicUpload) {
    profilePicPreview.addEventListener('click', () => {
      profilePicUpload.click();
    });
    
    profilePicUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleProfilePicUpload(file);
      }
    });
  }
  
  // Edit profile picture upload
  const editProfilePicPreview = document.getElementById('edit-profile-pic-preview');
  const editProfilePicUpload = document.getElementById('edit-profile-pic-upload');
  
  if (editProfilePicPreview && editProfilePicUpload) {
    editProfilePicPreview.addEventListener('click', () => {
      editProfilePicUpload.click();
    });
    
    editProfilePicUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleEditProfilePicUpload(file);
      }
    });
  }
  
  // Profile avatar click
  const profileAvatar = document.getElementById('profile-avatar');
  if (profileAvatar) {
    profileAvatar.addEventListener('click', () => {
      toggleProfileDropdown();
    });
  }
  
  // Profile dropdown menu items
  const editAccountBtn = document.getElementById('edit-account-btn');
  if (editAccountBtn) {
    editAccountBtn.addEventListener('click', (e) => {
      e.preventDefault();
      showEditAccountModal();
      toggleProfileDropdown(); // Close dropdown
    });
  }
  
  const changePasswordBtn = document.getElementById('change-password-btn');
  if (changePasswordBtn) {
    changePasswordBtn.addEventListener('click', (e) => {
      e.preventDefault();
      showChangePasswordModal();
      toggleProfileDropdown(); // Close dropdown
    });
  }
  
  const viewDashboardBtn = document.getElementById('view-dashboard-btn');
  if (viewDashboardBtn) {
    viewDashboardBtn.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('dashboard');
      toggleProfileDropdown(); // Close dropdown
    });
  }
  
  const viewSubscriptionBtn = document.getElementById('view-subscription-btn');
  if (viewSubscriptionBtn) {
    viewSubscriptionBtn.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('pricing');
      toggleProfileDropdown(); // Close dropdown
    });
  }
  
  const helpSupportBtn = document.getElementById('help-support-btn');
  if (helpSupportBtn) {
    helpSupportBtn.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('help');
      toggleProfileDropdown(); // Close dropdown
    });
  }
  
  const dropdownLogoutBtn = document.getElementById('dropdown-logout-btn');
  if (dropdownLogoutBtn) {
    dropdownLogoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      logoutUser();
      toggleProfileDropdown(); // Close dropdown
    });
  }
  
  // Alert modal close button
  const alertClose = document.getElementById('alert-close');
  if (alertClose) {
    alertClose.addEventListener('click', () => {
      const alertModal = document.getElementById('alert-modal');
      if (alertModal) alertModal.style.display = 'none';
    });
  }
  
  // Out of tokens modal close button
  const outOfTokensClose = document.getElementById('out-of-tokens-close');
  if (outOfTokensClose) {
    outOfTokensClose.addEventListener('click', () => {
      hideOutOfTokensModal();
    });
  }
  
  // Buy more tokens button
  const buyMoreTokensBtn = document.getElementById('buy-more-tokens-btn');
  if (buyMoreTokensBtn) {
    buyMoreTokensBtn.addEventListener('click', () => {
      hideOutOfTokensModal();
      showSection('pricing'); // Navigate to pricing page
    });
  }
  
  // Forgot password button
  const forgotPasswordBtn = document.getElementById('forgot-password-btn');
  if (forgotPasswordBtn) {
    forgotPasswordBtn.addEventListener('click', () => {
      showResetPasswordModal();
    });
  }
  
  // Reset password form
  const resetPasswordForm = document.getElementById('reset-password-form');
  if (resetPasswordForm) {
    resetPasswordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear previous messages
      const resetPasswordError = document.getElementById('reset-password-error');
      const resetPasswordSuccess = document.getElementById('reset-password-success');
      
      if (resetPasswordError) resetPasswordError.classList.add('hidden');
      if (resetPasswordSuccess) resetPasswordSuccess.classList.add('hidden');
      
      const resetEmail = document.getElementById('reset-email');
      if (!resetEmail) return;
      
      const email = resetEmail.value;
      
      try {
        await sendPasswordResetEmail(email);
        if (resetPasswordSuccess) {
          resetPasswordSuccess.textContent = "Password reset link sent! Please check your email.";
          resetPasswordSuccess.classList.remove('hidden');
        }
        
        // Auto-redirect to login after a delay
        setTimeout(() => {
          showLoginModal();
        }, 3000);
        
      } catch (error) {
        console.error("Reset password error:", error);
        if (resetPasswordError) {
          resetPasswordError.textContent = error.message;
          resetPasswordError.classList.remove('hidden');
        }
      }
    });
  }
  
  // Cancel reset password button
  const cancelResetPassword = document.getElementById('cancel-reset-password');
  if (cancelResetPassword) {
    cancelResetPassword.addEventListener('click', () => {
      showLoginModal();
    });
  }
  
  // Edit account form
  const editAccountForm = document.getElementById('edit-account-form');
  if (editAccountForm) {
    editAccountForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear previous messages
      const editAccountError = document.getElementById('edit-account-error');
      const editAccountSuccess = document.getElementById('edit-account-success');
      
      if (editAccountError) editAccountError.classList.add('hidden');
      if (editAccountSuccess) editAccountSuccess.classList.add('hidden');
      
      const editFullname = document.getElementById('edit-fullname');
      const editProfilePicUpload = document.getElementById('edit-profile-pic-upload');
      
      if (!editFullname || !editProfilePicUpload) return;
      
      const fullName = editFullname.value;
      const profilePicture = editProfilePicUpload.files[0] || null;
      
      try {
        await updateUserProfile(fullName, profilePicture);
        if (editAccountSuccess) {
          editAccountSuccess.textContent = "Profile updated successfully!";
          editAccountSuccess.classList.remove('hidden');
        }
        
        // Update UI to reflect changes
        updateUIForAuthState();
        
        // Auto-close after a delay
        setTimeout(() => {
          hideAuthModals();
        }, 2000);
        
      } catch (error) {
        console.error("Edit account error:", error);
        if (editAccountError) {
          editAccountError.textContent = error.message;
          editAccountError.classList.remove('hidden');
        }
      }
    });
  }
  
  // Cancel edit account button
  const cancelEditAccount = document.getElementById('cancel-edit-account');
  if (cancelEditAccount) {
    cancelEditAccount.addEventListener('click', () => {
      hideAuthModals();
    });
  }
  
  // Change password form
  const changePasswordForm = document.getElementById('change-password-form');
  if (changePasswordForm) {
    changePasswordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear previous messages
      const changePasswordError = document.getElementById('change-password-error');
      const changePasswordSuccess = document.getElementById('change-password-success');
      
      if (changePasswordError) changePasswordError.classList.add('hidden');
      if (changePasswordSuccess) changePasswordSuccess.classList.add('hidden');
      
      const currentPassword = document.getElementById('current-password');
      const newPassword = document.getElementById('new-password');
      const confirmNewPassword = document.getElementById('confirm-new-password');
      
      if (!currentPassword || !newPassword || !confirmNewPassword) return;
      
      // Validate passwords
      if (newPassword.value !== confirmNewPassword.value) {
        if (changePasswordError) {
          changePasswordError.textContent = "New passwords do not match";
          changePasswordError.classList.remove('hidden');
        }
        return;
      }
      
      if (newPassword.value.length < 6) {
        if (changePasswordError) {
          changePasswordError.textContent = "New password must be at least 6 characters";
          changePasswordError.classList.remove('hidden');
        }
        return;
      }
      
      try {
        await changeUserPassword(currentPassword.value, newPassword.value);
        if (changePasswordSuccess) {
          changePasswordSuccess.textContent = "Password changed successfully!";
          changePasswordSuccess.classList.remove('hidden');
        }
        
        // Auto-close after a delay
        setTimeout(() => {
          hideAuthModals();
        }, 2000);
        
      } catch (error) {
        console.error("Change password error:", error);
        if (changePasswordError) {
          changePasswordError.textContent = error.message;
          changePasswordError.classList.remove('hidden');
        }
      }
    });
  }
  
  // Cancel change password button
  const cancelChangePassword = document.getElementById('cancel-change-password');
  if (cancelChangePassword) {
    cancelChangePassword.addEventListener('click', () => {
      hideAuthModals();
    });
  }
  
  // Google Sign-In buttons
  const googleSignInBtn = document.getElementById('google-signin-btn');
  if (googleSignInBtn) {
    googleSignInBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signInWithGoogle();
      } catch (error) {
        console.error("Google sign in error:", error);
        const loginError = document.getElementById('login-error');
        if (loginError) {
          loginError.textContent = error.message || "Failed to sign in with Google";
          loginError.classList.remove('hidden');
        }
      }
    });
  }
  
  const googleSignupBtn = document.getElementById('google-signup-btn');
  if (googleSignupBtn) {
    googleSignupBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signInWithGoogle();
      } catch (error) {
        console.error("Google sign up error:", error);
        const signupError = document.getElementById('signup-error');
        if (signupError) {
          signupError.textContent = error.message || "Failed to sign up with Google";
          signupError.classList.remove('hidden');
        }
      }
    });
  }
  
  // Login form
  const loginForm = document.getElementById('login-form');
  if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const loginError = document.getElementById('login-error');
      if (loginError) loginError.classList.add('hidden');
      
      const loginEmail = document.getElementById('login-email');
      const loginPassword = document.getElementById('login-password');
      
      if (!loginEmail || !loginPassword) return;
      
      try {
        await loginUser(loginEmail.value, loginPassword.value);
      } catch (error) {
        console.error("Login error:", error);
        if (loginError) {
          loginError.textContent = error.message;
          loginError.classList.remove('hidden');
        }
      }
    });
  }
  
  // Sign-up form
  const signupForm = document.getElementById('signup-form');
  if (signupForm) {
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const signupError = document.getElementById('signup-error');
      if (signupError) signupError.classList.add('hidden');
      
      const signupEmail = document.getElementById('signup-email');
      const signupPassword = document.getElementById('signup-password');
      const signupConfirmPassword = document.getElementById('signup-confirm-password');
      const signupFullname = document.getElementById('signup-fullname');
      const profilePicUpload = document.getElementById('profile-pic-upload');
      
      if (!signupEmail || !signupPassword || !signupConfirmPassword || !signupFullname || !profilePicUpload) return;
      
      try {
        await createUser(
          signupEmail.value,
          signupPassword.value,
          signupConfirmPassword.value,
          signupFullname.value,
          profilePicUpload.files[0] || null
        );
      } catch (error) {
        console.error("Sign-up error:", error);
        if (signupError) {
          signupError.textContent = error.message;
          signupError.classList.remove('hidden');
        }
      }
    });
  }
  
  // Generate 3D model button (UPDATED)
  const generateBtn = document.getElementById('generate-btn');
  if (generateBtn) {
    generateBtn.addEventListener('click', async () => {
      // Check if user is logged in
      if (!currentUser) {
        showLoginModal();
        return;
      }
      
      // Check if user has enough tokens
      if (!hasEnoughTokens()) {
        showOutOfTokensModal();
        return;
      }
      
      // Clear logs
      const logsContent = document.getElementById('logs-content');
      if (logsContent) logsContent.innerHTML = '';
      
      // Get input (image or text)
      let inputType, inputData, modelName;
      const uploadInput = document.getElementById('upload-input');
      if (uploadInput && !uploadInput.classList.contains('hidden')) {
        // Image upload mode
        const fileInput = document.getElementById('file-upload');
        if (!fileInput || !fileInput.files || !fileInput.files[0]) {
          showAlert('Missing Input', 'Please upload an image file');
          return;
        }
        inputData = fileInput.files[0];
        inputType = 'image';
        modelName = fileInput.files[0].name;
        
        logToUI(`Processing image: ${modelName}`, "info");
      } else {
        // Text description mode
        const description = document.getElementById('description');
        if (!description || !description.value.trim()) {
          showAlert('Missing Input', 'Please enter a description for your 3D model');
          return;
        }
        inputData = description.value.trim();
        inputType = 'text';
        modelName = inputData.substring(0, 30) + (inputData.length > 30 ? '...' : '');
        
        logToUI(`Processing description: "${inputData}"`, "info");
      }
      
      // Show loading state
      const initialState = document.getElementById('initial-state');
      const loadingState = document.getElementById('loading-state');
      const generateText = document.getElementById('generate-text');
      const generatingText = document.getElementById('generating-text');
      
      if (initialState) initialState.classList.add('hidden');
      if (loadingState) loadingState.classList.remove('hidden');
      if (generateText) generateText.classList.add('hidden');
      if (generatingText) generatingText.classList.remove('hidden');
      
      try {
        // Use AI to generate 3D model
        await generateAIModel(inputType, inputData);
        
        // Record model data and update user tokens
        if (db && currentUser && !userIsOwner) {
          try {
            const userDocRef = db.collection('users').doc(currentUser.uid);
            const doc = await userDocRef.get();
            
            if (doc.exists) {
              const userData = doc.data();
              
              // Create model record
              const modelRecord = {
                name: modelName,
                type: inputType,
                prompt: inputType === 'text' ? inputData : `Image: ${modelName}`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              // Update user document
              const updatedModels = userData.models ? [...userData.models, modelRecord] : [modelRecord];
              await userDocRef.update({
                tokens: Math.max(0, userData.tokens - 1),
                models: updatedModels
              });
              
              // Update UI
              if (document.getElementById('token-count')) {
                document.getElementById('token-count').textContent = Math.max(0, userData.tokens - 1);
              }
              if (document.getElementById('dashboard-token-count')) {
                document.getElementById('dashboard-token-count').textContent = Math.max(0, userData.tokens - 1);
              }
              if (document.getElementById('models-created-count')) {
                document.getElementById('models-created-count').textContent = updatedModels.length;
              }
            }
          } catch (e) {
            console.error("Error updating user data:", e);
            logToUI("Failed to update user data in database", "error");
          }
        }
      } catch (error) {
        console.error("Error generating 3D model:", error);
        
        // Stop processing timer
        stopProcessingTimer();
        
        // Reset UI
        if (loadingState) loadingState.classList.add('hidden');
        if (initialState) initialState.classList.remove('hidden');
        if (generateText) generateText.classList.remove('hidden');
        if (generatingText) generatingText.classList.add('hidden');
        
        logToUI(`Error: ${error.message || 'Unknown error'}`, "error");
        showAlert('Generation Error', `Error generating model: ${error.message || 'Unknown error'}`);
      }
    });
  }
  
  // Reset button
  const resetBtn = document.getElementById('reset-btn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      // Reset UI
      const loadingState = document.getElementById('loading-state');
      const initialState = document.getElementById('initial-state');
      const downloadOptions = document.getElementById('download-options');
      
      if (loadingState) loadingState.classList.add('hidden');
      if (initialState) initialState.classList.remove('hidden');
      if (downloadOptions) downloadOptions.classList.add('hidden');
      
      // Clear inputs
      const description = document.getElementById('description');
      if (description) description.value = '';
      clearFileUpload();
      
      // Reset to demo cube
      if (cube) {
        scene.remove(cube);
        cube = null;
      }
      createDemoCube();
      
      // Reset button states
      const generateText = document.getElementById('generate-text');
      const generatingText = document.getElementById('generating-text');
      if (generateText) generateText.classList.remove('hidden');
      if (generatingText) generatingText.classList.add('hidden');
      
      // Clear current model
      currentModel = null;
      
      // Stop processing timer
      stopProcessingTimer();
      
      // Clear logs
      const logsContent = document.getElementById('logs-content');
      if (logsContent) logsContent.innerHTML = '';
      
      logToUI("Reset for new model generation", "info");
    });
  }
  
  // Download button (UPDATED)
  const downloadBtn = document.getElementById('download-btn');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      if (!cube) {
        showAlert('Download Error', 'No model available for download. Please generate a model first.');
        return;
      }
      
      const format = document.getElementById('export-format').value || 'stl';
      
      try {
        // Export using Three.js exporters
        logToUI(`Exporting model as ${format.toUpperCase()}...`, "info");
        const blob = await exportModel(format);
        
        if (blob) {
          // Create download link
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `3DModel.${format.toLowerCase()}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          showAlert('Download Complete', `Your ${format.toUpperCase()} file has been downloaded.`);
          logToUI(`Model downloaded in ${format.toUpperCase()} format`, "success");
        } else {
          showAlert('Export Error', `Failed to export model as ${format.toUpperCase()}.`);
          logToUI(`Failed to export model as ${format.toUpperCase()}`, "error");
        }
      } catch (error) {
        console.error("Download error:", error);
        showAlert('Export Error', 'Failed to download model. Please try again.');
        logToUI(`Download failed: ${error.message}`, "error");
      }
    });
  }
  
  // Subscribe buttons
  document.querySelectorAll('.subscribe-btn').forEach(button => {
    button.addEventListener('click', () => {
      // Check if user is logged in
      if (!currentUser) {
        showLoginModal();
        return;
      }
      
      const plan = button.getAttribute('data-plan');
      const checkoutId = button.getAttribute('data-checkout-id');
      
      // For the free plan, handle specially (no checkout needed)
      if (plan === 'free') {
        showAlert("Already Free", "You already have the free plan with 10 tokens.");
        return;
      }
      
      // Redirect to Stripe checkout
      redirectToStripeCheckout(checkoutId);
      
      // Record the subscription attempt in Firebase
      if (db && currentUser) {
        try {
          const userDocRef = db.collection('users').doc(currentUser.uid);
          userDocRef.update({
            subscription_attempt: {
              plan: plan,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }
          }).catch(error => {
            console.error("Error recording subscription attempt:", error);
          });
        } catch (e) {
          console.error("Error updating subscription data:", e);
        }
      }
    });
  });
  
  // Buy tokens button in dashboard
  const buyTokensBtn = document.getElementById('buy-tokens-btn');
  if (buyTokensBtn) {
    buyTokensBtn.addEventListener('click', () => {
      // Check if user is logged in
      if (!currentUser) {
        showLoginModal();
        return;
      }
      
      // Navigate to pricing page
      showSection('pricing');
    });
  }
  
  // Upgrade button in dashboard
  const upgradeBtn = document.getElementById('upgrade-btn');
  if (upgradeBtn) {
    upgradeBtn.addEventListener('click', () => {
      showSection('pricing');
    });
  }
  
  // Contact support button
  const contactSupportBtn = document.getElementById('contact-support-btn');
  if (contactSupportBtn) {
    contactSupportBtn.addEventListener('click', () => {
      showAlert('Contact Support', 'Please email us at support@3dreamlabz.com for any questions or assistance.');
    });
  }
  
  // Password strength meter
  const signupPassword = document.getElementById('signup-password');
  const passwordStrength = document.getElementById('password-strength');
  
  if (signupPassword && passwordStrength) {
    signupPassword.addEventListener('input', () => {
      const password = signupPassword.value;
      
      // Simple strength check
      const hasUppercase = /[A-Z]/.test(password);
      const hasLowercase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      const hasSpecialChars = /[!@#$%^&*(),.?":{}|<>]/.test(password);
      const isLongEnough = password.length >= 8;
      
      const strength = [hasUppercase, hasLowercase, hasNumbers, hasSpecialChars, isLongEnough].filter(Boolean).length;
      
      // Clear existing classes
      passwordStrength.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
      
      if (password.length > 0) {
        if (strength <= 2) {
          passwordStrength.classList.add('strength-weak');
        } else if (strength <= 4) {
          passwordStrength.classList.add('strength-medium');
        } else {
          passwordStrength.classList.add('strength-strong');
        }
      }
    });
  }
  
  // New password strength meter
  const newPasswordInput = document.getElementById('new-password');
  const newStrengthIndicator = document.getElementById('new-password-strength');
  
  if (newPasswordInput && newStrengthIndicator) {
    newPasswordInput.addEventListener('input', () => {
      const password = newPasswordInput.value;
      
      // Simple strength check
      const hasUppercase = /[A-Z]/.test(password);
      const hasLowercase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      const hasSpecialChars = /[!@#$%^&*(),.?":{}|<>]/.test(password);
      const isLongEnough = password.length >= 8;
      
      const strength = [hasUppercase, hasLowercase, hasNumbers, hasSpecialChars, isLongEnough].filter(Boolean).length;
      
      // Clear existing classes
      newStrengthIndicator.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
      
      if (password.length > 0) {
        if (strength <= 2) {
          newStrengthIndicator.classList.add('strength-weak');
        } else if (strength <= 4) {
          newStrengthIndicator.classList.add('strength-medium');
        } else {
          newStrengthIndicator.classList.add('strength-strong');
        }
      }
    });
  }
  
  // Implement click outside to close for profile dropdown
  document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('profile-dropdown-menu');
    const avatar = document.getElementById('profile-avatar');
    
    if (dropdown && dropdown.classList.contains('active') && 
        avatar && !dropdown.contains(event.target) && 
        !avatar.contains(event.target)) {
      dropdown.classList.remove('active');
    }
  });

  // Add log greeting
  logToUI("3D model generator ready! Upload an image or enter a text description to get started.", "info");
  
  // Log backend API availability
  logToUI(`Using Point-E backend API for advanced AI model generation`, "success");
  
  // Show app section by default
  showSection('app');
});

// Helper function for profile picture handling
function handleProfilePicUpload(file) {
  if (!file || !file.type.startsWith('image/')) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const profilePicImg = document.getElementById('profile-pic-img');
    if (profilePicImg) {
      profilePicImg.src = e.target.result;
      profilePicImg.classList.remove('hidden');
    }
  };
  reader.readAsDataURL(file);
}

function handleEditProfilePicUpload(file) {
  if (!file || !file.type.startsWith('image/')) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const editProfilePicImg = document.getElementById('edit-profile-pic-img');
    if (editProfilePicImg) {
      editProfilePicImg.src = e.target.result;
      editProfilePicImg.classList.remove('hidden');
    }
  };
  reader.readAsDataURL(file);
}

// 3DREAM LABZ Particle Effects
document.addEventListener('DOMContentLoaded', function() {
    const dreamText = document.getElementById('dreamText');
    const particles = document.getElementById('particles');

    if (dreamText && particles) {
        function createParticle() {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 3 + 's';
            particle.style.animationDuration = (Math.random() * 2 + 2) + 's';
            particles.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, 5000);
        }

        dreamText.addEventListener('mouseenter', () => {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => createParticle(), i * 100);
            }
        });

        // Create some ambient particles
        setInterval(createParticle, 500);
    }
});

function pageTransitionNavigate(url) {
  const overlay = document.getElementById('pageTransitionOverlay');
  overlay.classList.add('active');
  setTimeout(() => {
    window.location.href = url;
  }, 350); // Match the CSS transition duration
}

// Animate overlay away on page load
window.addEventListener('DOMContentLoaded', () => {
  const overlay = document.getElementById('pageTransitionOverlay');
  overlay.style.transform = 'translateX(0)';
  setTimeout(() => {
    overlay.style.transition = 'transform 0.35s cubic-bezier(.77,0,.18,1)';
    overlay.style.transform = 'translateX(-100%)';
  }, 50);
});
</script>

<!-- Start of HubSpot Embed Code -->
<script type="text/javascript" id="hs-script-loader" async defer src="//js-eu1.hs-scripts.com/146722646.js"></script>
<!-- End of HubSpot Embed Code -->

<footer class="w-full text-center py-4 bg-gray-900 text-white border-t border-gray-700">
  © 2025 3Dream Labs. All rights reserved.
</footer>
</body>
</html>
